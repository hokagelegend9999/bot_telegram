import logging
import sqlite3
import datetime as DT
import os
import paramiko
import asyncio

# Import PTB specific modules
from telegram import Update, ReplyKeyboardMarkup, KeyboardButton
from telegram.ext import Application, CommandHandler, MessageHandler, ContextTypes, filters, ConversationHandler

# --- KONFIGURASI LOGGING ---
logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s", level=logging.INFO
)
logging.getLogger("httpx").setLevel(logging.WARNING)
logger = logging.getLogger(__name__)

# --- KONFIGURASI BOT ---
BOT_TOKEN = '7948291780:AAGMIaOD1cS2l_SZZq6DejAU14VlAWu-sDU' # Ganti dengan Bot Token dari BotFather

# Nama file database
DB_FILE = '/usr/bin/jualan.db' 

# --- KONFIGURASI SSH KE VPS ---
SSH_HOST = "localhost"
SSH_USERNAME = os.getenv("SSH_USERNAME", "root") 
SSH_PASSWORD = os.getenv("SSH_PASSWORD", "") 

# --- FUNGSI DATABASE ---
def get_db_connection():
    """Membuka koneksi ke database."""
    conn = sqlite3.connect(DB_FILE)
    conn.row_factory = sqlite3.Row
    return conn

def init_db():
    """Menginisialisasi database dan membuat tabel jika belum ada."""
    conn = get_db_connection()
    cursor = conn.cursor()

    cursor.execute('''
        CREATE TABLE IF NOT EXISTS users (
            user_id INTEGER PRIMARY KEY,
            balance REAL DEFAULT 0.0,
            registered_at TEXT
        )
    ''')
    conn.commit()
    conn.close()

init_db()
logger.info("Database initialized.")

# --- FUNGSI UNTUK MEMBUAT KEYBOARD MENU ---
def get_main_menu_keyboard():
    """Mengembalikan objek ReplyKeyboardMarkup untuk menu utama bot."""
    buttons = [
        [KeyboardButton('MENU SSH OVPN')], 
        [KeyboardButton('MENU VMESS'), KeyboardButton('MENU VLESS')], # MENU VMESS sekarang akan ke sub-menu
        [KeyboardButton('MENU TROJAN'), KeyboardButton('MENU SHDWSK')],
        [KeyboardButton('CHECK SERVICE'), KeyboardButton('OTHER SETTING')],
        [KeyboardButton('TOPUP SALDO [QRIS]')],
        [KeyboardButton('REFRESH')]
    ]
    return ReplyKeyboardMarkup(buttons, resize_keyboard=True, one_time_keyboard=False)

# Sub-menu untuk SSH OVPN (tidak lagi khusus VMess creation)
def get_ssh_ovpn_menu_keyboard():
    """Mengembalikan ReplyKeyboardMarkup untuk sub-menu SSH OVPN."""
    buttons = [
        # Anda bisa menambahkan tombol khusus SSH OVPN di sini
        [KeyboardButton('INFO SSH OVPN')], # Contoh tombol info
        [KeyboardButton('Back to Main Menu')]
    ]
    return ReplyKeyboardMarkup(buttons, resize_keyboard=True, one_time_keyboard=False)

# Sub-menu BARU untuk VMESS
def get_vmess_creation_menu_keyboard():
    """Mengembalikan ReplyKeyboardMarkup untuk sub-menu VMESS (pembuatan/trial)."""
    buttons = [
        [KeyboardButton('CREATE AKUN VMESS')], # Ini akan memicu VMess conversation
        [KeyboardButton('CREATE TRIAL VMESS')], # Ini akan memicu VMess trial
        [KeyboardButton('Back to Main Menu')]
    ]
    return ReplyKeyboardMarkup(buttons, resize_keyboard=True, one_time_keyboard=False)

def get_trojan_menu_keyboard():
    """Mengembalikan ReplyKeyboardMarkup untuk sub-menu Trojan."""
    buttons = [
        [KeyboardButton('CREATE TRIAL TROJAN')], # Ini akan memicu trial Trojan
        [KeyboardButton('CREATE AKUN TROJAN')], # Placeholder, jika ada akun Trojan non-trial
        [KeyboardButton('Back to Main Menu')]
    ]
    return ReplyKeyboardMarkup(buttons, resize_keyboard=True, one_time_keyboard=False)

# --- FUNGSI UNTUK MENJALANKAN PERINTAH SHELL MELALUI SSH ---
async def run_ssh_command(command: str):
    """
    Menjalankan perintah shell di VPS melalui SSH dan mengembalikan outputnya.
    Menggunakan autentikasi kata sandi.
    """
    client = paramiko.SSHClient()
    client.set_missing_host_key_policy(paramiko.AutoAddPolicy())

    try:
        client.connect(hostname=SSH_HOST, username=SSH_USERNAME, password=SSH_PASSWORD)

        logger.info(f"Executing SSH command: {command}")
        stdin, stdout, stderr = client.exec_command(command)
        
        output = stdout.read().decode('utf-8').strip()
        error = stderr.read().decode('utf-8').strip()

        if error:
            logger.error(f"Error from SSH command '{command}': {error}")
            return f"Error saat menjalankan perintah di server:\n`{error}`"
        
        if not output:
            return "Perintah berhasil dijalankan, tetapi tidak ada output yang dikembalikan."

        return output

    except paramiko.AuthenticationException:
        logger.critical("Gagal otentikasi SSH. Pastikan username dan password SSH benar.")
        return "Error server: Gagal otentikasi SSH. Mohon hubungi administrator."
    except paramiko.SSHException as e:
        logger.critical(f"Terjadi kesalahan SSH: {e}")
        return f"Error server SSH: {e}"
    except Exception as e:
        logger.critical(f"Terjadi kesalahan tak terduga saat menjalankan perintah SSH: {e}")
        return f"Terjadi kesalahan tak terduga di server: {e}"
    finally:
        if client:
            client.close()

# --- HANDLER UNTUK PERINTAH /start ---
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Mengirim pesan sambutan saat perintah /start diterima."""
    user_id = update.effective_user.id
    username = update.effective_user.username if update.effective_user.username else f"ID:{user_id}"

    conn = get_db_connection()
    cursor = conn.cursor()

    cursor.execute("SELECT user_id FROM users WHERE user_id = ?", (user_id,))
    existing_user = cursor.fetchone()

    if existing_user:
        logger.info(f"User {username} ({user_id}) already registered. Sending welcome back message with menu.")
        await update.message.reply_text(
            f'Selamat datang kembali, {username}!\n'
            f'Silakan pilih opsi layanan:',
            reply_markup=get_main_menu_keyboard()
        )
    else:
        registered_at = DT.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        cursor.execute("INSERT INTO users (user_id, balance, registered_at) VALUES (?, ?, ?)",
                       (user_id, 0.0, registered_at))
        conn.commit()
        logger.info(f"New user registered: {username} ({user_id})")
        await update.message.reply_text(
            f'Halo, {username}! Selamat datang di bot kami!\n'
            f'Anda berhasil terdaftar di sistem kami dengan saldo awal Rp 0.\n'
            f'Silakan pilih opsi layanan:',
            reply_markup=get_main_menu_keyboard()
        )
    conn.close()

# --- HANDLER UNTUK PERINTAH /menu (Jika user ingin menampilkan menu lagi) ---
async def show_menu(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Menampilkan keyboard menu."""
    user_id = update.effective_user.id
    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute("SELECT user_id FROM users WHERE user_id = ?", (user_id,))
    existing_user = cursor.fetchone()
    conn.close()

    if existing_user:
        await update.message.reply_text(
            'Silakan pilih opsi layanan:',
            reply_markup=get_main_menu_keyboard()
        )
    else:
        await update.message.reply_text('Maaf, Anda belum terdaftar. Silakan gunakan perintah /start terlebih dahulu.')

# --- FUNGSI HELPER UNTUK HANDLER TOMBOL YANG MENJALANKAN SKRIP UMUM ---
async def handle_general_script_button(update: Update, context: ContextTypes.DEFAULT_TYPE, script_path: str, message_loading: str, message_error: str, return_markup: ReplyKeyboardMarkup = None) -> None:
    """
    Fungsi helper untuk menangani penekanan tombol yang akan mengeksekusi skrip SSH.
    Digunakan untuk skrip yang tidak memerlukan input interaktif.
    """
    if return_markup is None:
        return_markup = get_main_menu_keyboard() # Default kembali ke menu utama

    await update.message.reply_text(message_loading)
    result = await run_ssh_command(f"bash {script_path}")
    if "Error:" in result or "Error server:" in result: # Check for specific error strings from bash or SSH
        await update.message.reply_text(f"{message_error}\n`{result}`", parse_mode='Markdown', reply_markup=return_markup)
    else:
        await update.message.reply_text(result, parse_mode='HTML', reply_markup=return_markup)


# --- HANDLER UNTUK MENU UTAMA (Navigasi ke Sub-Menu) ---
async def menu_ssh_ovpn_main(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Menampilkan sub-menu SSH OVPN."""
    await update.message.reply_text(
        "Anda di Menu SSH OVPN. Pilih opsi:",
        reply_markup=get_ssh_ovpn_menu_keyboard()
    )

async def menu_vmess_main(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Menampilkan sub-menu VMESS (untuk pembuatan/trial)."""
    await update.message.reply_text(
        "Anda di Menu VMESS. Pilih opsi:",
        reply_markup=get_vmess_creation_menu_keyboard()
    )

async def menu_trojan_main(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Menampilkan sub-menu Trojan."""
    await update.message.reply_text(
        "Anda di Menu TROJAN. Pilih opsi:",
        reply_markup=get_trojan_menu_keyboard()
    )

# --- Handler untuk tombol 'Back to Main Menu' ---
async def back_to_main_menu(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Mengembalikan ke menu utama."""
    await update.message.reply_text(
        "Kembali ke Menu Utama:",
        reply_markup=get_main_menu_keyboard()
    )

# --- HANDLER UNTUK TOMBOL MENU UMUM (tidak memerlukan input interaktif) ---
# Perhatikan: menu_vmess_handler LAMA sekarang diganti oleh menu_vmess_main (untuk navigasi)
# Jika ada skrip '/usr/bin/bot-cek-vmess', maka akan dipanggil di bawah 'CHECK VMESS SERVICE' di sub-menu VMESS.

async def menu_vless_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    await handle_general_script_button(update, context, '/usr/bin/bot-cek-vless',
                               message_loading='Memuat menu VLESS...',
                               message_error='Gagal memuat menu VLESS.')

async def menu_shdwsk_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    await handle_general_script_button(update, context, '/usr/bin/bot-trialss',
                               message_loading='Memuat menu SHADOWSOCKS...',
                               message_error='Gagal memuat menu SHADOWSOCKS.')

async def check_service_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    await handle_general_script_button(update, context, '/usr/bin/resservice',
                               message_loading='Memeriksa status layanan...',
                               message_error='Gagal memeriksa status layanan.')

async def other_setting_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    await handle_general_script_button(update, context, '/usr/bin/other-setting',
                               message_loading='Memuat opsi pengaturan lain...',
                               message_error='Gagal memuat opsi pengaturan lain.')

# --- HANDLER UNTUK TOMBOL "CREATE TRIAL TROJAN" ---
async def create_trial_trojan_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    # Memastikan bot kembali ke sub-menu Trojan setelah trial
    await handle_general_script_button(update, context, '/usr/bin/bot-trial', # Path ke skrip trial Trojan
                               message_loading='Membuat akun trial Trojan...',
                               message_error='Gagal membuat akun trial Trojan.',
                               return_markup=get_trojan_menu_keyboard())

# --- HANDLER UNTUK TOMBOL "CREATE TRIAL VMESS" ---
async def create_trial_vmess_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    # Memastikan bot kembali ke sub-menu VMess setelah trial
    await handle_general_script_button(update, context, '/usr/bin/bot-trialws', # Path ke skrip trial VMess WS
                               message_loading='Membuat akun trial VMESS...',
                               message_error='Gagal membuat akun VMESS.',
                               return_markup=get_vmess_creation_menu_keyboard())

# --- HANDLER KHUSUS untuk 'CHECK VMESS SERVICE' di sub-menu VMESS ---
async def check_vmess_service_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    await handle_general_script_button(update, context, '/usr/bin/bot-cek-vmess', # Ini adalah skrip yang sebelumnya error
                               message_loading='Memeriksa status VMESS...',
                               message_error='Gagal memeriksa status VMESS.',
                               return_markup=get_vmess_creation_menu_keyboard())


# --- HANDLER TOMBOL TANPA EKSEKUSI SKRIP (Untuk tombol yang hanya membalas teks) ---
async def info_ssh_ovpn_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Handler untuk tombol INFO SSH OVPN di sub-menu SSH OVPN."""
    await update.message.reply_text('Informasi tentang layanan SSH OVPN akan ditampilkan di sini.', reply_markup=get_ssh_ovpn_menu_keyboard())


async def create_akun_trojan_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    await update.message.reply_text('Fitur pembuatan akun Trojan penuh akan segera tersedia.', reply_markup=get_trojan_menu_keyboard())

async def create_akun_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    await update.message.reply_text('Anda memilih CREATE AKUN. Proses pembuatan akun akan dimulai.', reply_markup=get_main_menu_keyboard())

async def renew_akun_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    await update.message.reply_text('Anda memilih RENEW AKUN. Fitur perpanjangan akun akan segera dikembangkan.', reply_markup=get_main_menu_keyboard())

async def topup_saldo_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    await update.message.reply_text('Anda memilih TOPUP SALDO [QRIS]. Instruksi top up akan diberikan.', reply_markup=get_main_menu_keyboard())

async def refresh_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    await update.message.reply_text('Anda memilih REFRESH. Data akan diperbarui.', reply_markup=get_main_menu_keyboard())

# --- States untuk ConversationHandler "CREATE AKUN VMESS" ---
VMESS_GET_USERNAME, VMESS_GET_EXPIRED_DAYS, VMESS_GET_QUOTA, VMESS_GET_IP_LIMIT = range(4)

async def create_akun_vmess_start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """Memulai percakapan untuk pembuatan akun VMESS (dipicu dari sub-menu VMESS)."""
    await update.message.reply_text("Baik, mari kita buat akun VMESS baru.\n"
                                    "Silakan masukkan Username:")
    return VMESS_GET_USERNAME

async def vmess_get_username(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """Menerima username dan meminta masa aktif (days)."""
    username = update.message.text
    if not username:
        await update.message.reply_text("Username tidak boleh kosong. Silakan masukkan Username:")
        return VMESS_GET_USERNAME
    
    if not username.isalnum() and "_" not in username:
        await update.message.reply_text("Username hanya boleh mengandung huruf, angka, dan underscore (_). Silakan masukkan Username yang valid:")
        return VMESS_GET_USERNAME

    context.user_data['vmess_username'] = username
    await update.message.reply_text("Username diterima. Sekarang, masukkan Masa Aktif (dalam hari, contoh: 30 untuk 30 hari):")
    return VMESS_GET_EXPIRED_DAYS

async def vmess_get_expired_days(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """Menerima masa aktif dan meminta limit kuota (GB)."""
    expired_days_str = update.message.text
    if not expired_days_str.isdigit():
        await update.message.reply_text("Masa aktif harus berupa angka. Silakan masukkan Masa Aktif (contoh: 30):")
        return VMESS_GET_EXPIRED_DAYS
    
    expired_days = int(expired_days_str)
    context.user_data['vmess_expired_days'] = expired_days
    await update.message.reply_text("Masa Aktif diterima. Sekarang, masukkan Limit Kuota (dalam GB, contoh: 10 untuk 10 GB):")
    return VMESS_GET_QUOTA

async def vmess_get_quota(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """Menerima limit kuota dan meminta batas IP."""
    quota_str = update.message.text
    if not quota_str.isdigit():
        await update.message.reply_text("Limit Kuota harus berupa angka. Silakan masukkan Limit Kuota (contoh: 10):")
        return VMESS_GET_QUOTA
    
    quota = int(quota_str)
    context.user_data['vmess_quota'] = quota
    await update.message.reply_text("Limit Kuota diterima. Terakhir, masukkan Batas User (jumlah IP, contoh: 2 untuk 2 IP):")
    return VMESS_GET_IP_LIMIT

async def vmess_get_ip_limit(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """Menerima batas IP, menjalankan skrip, dan mengirim hasilnya."""
    ip_limit_str = update.message.text
    if not ip_limit_str.isdigit():
        await update.message.reply_text("Batas User (IP) harus berupa angka. Silakan masukkan Batas User (contoh: 2):")
        return VMESS_GET_IP_LIMIT
    
    ip_limit = int(ip_limit_str)
    context.user_data['vmess_ip_limit'] = ip_limit

    username = context.user_data['vmess_username']
    expired_days = context.user_data['vmess_expired_days']
    quota = context.user_data['vmess_quota']

    await update.message.reply_text(
        f"Membuat akun VMESS dengan detail:\n"
        f"Username: `{username}`\n"
        f"Masa Aktif: `{expired_days}` hari\n"
        f"Limit Kuota: `{quota}` GB\n"
        f"Batas IP: `{ip_limit}`\n"
        f"Mohon tunggu..."
    )

    command = f"bash /usr/bin/addws-bot {username} {expired_days} {quota} {ip_limit}"
    result_ssh = await run_ssh_command(command) 

    if "Error:" in result_ssh or "Error server:" in result_ssh:
        await update.message.reply_text(f"Gagal membuat akun VMESS:\n\n`{result_ssh}`", parse_mode='Markdown', reply_markup=get_vmess_creation_menu_keyboard()) # Kembali ke sub-menu VMESS
    else:
        await update.message.reply_text(f"Akun VMESS berhasil dibuat!\n\n{result_ssh}", parse_mode='HTML', reply_markup=get_vmess_creation_menu_keyboard()) # Kembali ke sub-menu VMESS

    context.user_data.clear()
    return ConversationHandler.END

async def cancel_conversation(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """Membatalkan percakapan."""
    await update.message.reply_text("Proses pembuatan akun dibatalkan.", reply_markup=get_main_menu_keyboard())
    context.user_data.clear()
    return ConversationHandler.END

async def unknown(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    if update.message and update.message.from_user and not update.message.from_user.is_bot:
        await update.message.reply_text(
            'Maaf, saya tidak mengerti perintah itu. Silakan gunakan tombol menu atau perintah /menu.',
            reply_markup=get_main_menu_keyboard()
        )

# --- FUNGSI UTAMA UNTUK MEMULAI BOT ---
def main() -> None:
    """Fungsi utama untuk memulai bot."""
    logger.info("Bot is starting...")

    if not SSH_USERNAME:
        logger.error("Variabel lingkungan SSH_USERNAME tidak disetel atau kosong.")
        exit(1)
    if not SSH_PASSWORD:
        logger.critical("Variabel lingkungan SSH_PASSWORD tidak disetel atau kosong. Bot tidak dapat memulai SSH.")
        exit(1)
    
    application = Application.builder().token(BOT_TOKEN).build()

    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("menu", show_menu))

    # --- Handler untuk navigasi ke Sub-Menu ---
    application.add_handler(MessageHandler(filters.Regex(r'^MENU SSH OVPN$'), menu_ssh_ovpn_main))
    application.add_handler(MessageHandler(filters.Regex(r'^MENU VMESS$'), menu_vmess_main)) # VMESS sekarang navigasi ke sub-menu
    application.add_handler(MessageHandler(filters.Regex(r'^MENU TROJAN$'), menu_trojan_main))
    # Tambahkan handler untuk menu utama lainnya yang akan menampilkan sub-menu

    # --- Handler untuk tombol 'Back to Main Menu' di semua sub-menu ---
    application.add_handler(MessageHandler(filters.Regex(r'^Back to Main Menu$'), back_to_main_menu))

    # --- Conversation Handler untuk VMESS (dipicu dari sub-menu VMESS) ---
    vmess_conv_handler = ConversationHandler(
        entry_points=[MessageHandler(filters.Regex(r'^CREATE AKUN VMESS$'), create_akun_vmess_start)],
        states={
            VMESS_GET_USERNAME: [MessageHandler(filters.TEXT & ~filters.COMMAND, vmess_get_username)],
            VMESS_GET_EXPIRED_DAYS: [MessageHandler(filters.TEXT & ~filters.COMMAND, vmess_get_expired_days)],
            VMESS_GET_QUOTA: [MessageHandler(filters.TEXT & ~filters.COMMAND, vmess_get_quota)],
            VMESS_GET_IP_LIMIT: [MessageHandler(filters.TEXT & ~filters.COMMAND, vmess_get_ip_limit)],
        },
        fallbacks=[CommandHandler("cancel", cancel_conversation), MessageHandler(filters.COMMAND, cancel_conversation)],
        allow_reentry=True 
    )
    application.add_handler(vmess_conv_handler)

    # --- Handler untuk tombol di Sub-Menu Trojan ---
    application.add_handler(MessageHandler(filters.Regex(r'^CREATE TRIAL TROJAN$'), create_trial_trojan_handler))
    application.add_handler(MessageHandler(filters.Regex(r'^CREATE AKUN TROJAN$'), create_akun_trojan_handler))

    # --- Handler untuk tombol di Sub-Menu VMESS ---
    application.add_handler(MessageHandler(filters.Regex(r'^CREATE TRIAL VMESS$'), create_trial_vmess_handler))
    application.add_handler(MessageHandler(filters.Regex(r'^CHECK VMESS SERVICE$'), check_vmess_service_handler)) # BARU: Handler untuk cek VMESS


    # --- Handler untuk tombol di Sub-Menu SSH OVPN ---
    application.add_handler(MessageHandler(filters.Regex(r'^INFO SSH OVPN$'), info_ssh_ovpn_handler)) # BARU: Handler info SSH OVPN


    # --- Handler untuk tombol menu umum lainnya (tidak memerlukan input interaktif) ---
    application.add_handler(MessageHandler(filters.Regex(r'^MENU VLESS$'), menu_vless_handler))
    application.add_handler(MessageHandler(filters.Regex(r'^MENU SHDWSK$'), menu_shdwsk_handler))
    application.add_handler(MessageHandler(filters.Regex(r'^CHECK SERVICE$'), check_service_handler))
    application.add_handler(MessageHandler(filters.Regex(r'^OTHER SETTING$'), other_setting_handler))
    application.add_handler(MessageHandler(filters.Regex(r'^TOPUP SALDO \[QRIS\]$'), topup_saldo_handler)) 
    application.add_handler(MessageHandler(filters.Regex(r'^REFRESH$'), refresh_handler))

    # Tanggapi semua pesan teks yang bukan perintah yang sudah ditangani (harus paling akhir)
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, unknown))


    logger.info("Bot running in polling mode...")
    application.run_polling(allowed_updates=Update.ALL_TYPES)

if __name__ == "__main__":
    main()
