#!/usr/bin/python3
# -*- coding: utf-8 -*-

import logging
import sqlite3
import datetime as DT
import os
import paramiko
import asyncio

# Import PTB specific modules
from telegram import Update, ReplyKeyboardMarkup, KeyboardButton, InputFile
from telegram.ext import Application, CommandHandler, MessageHandler, ContextTypes, filters, ConversationHandler

# --- KONFIGURASI LOGGING ---
logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s", level=logging.INFO
)
logging.getLogger("httpx").setLevel(logging.WARNING)
logger = logging.getLogger(__name__)

# --- KONFIGURASI BOT ---
BOT_TOKEN = '7948291780:AAGMIaOD1cS2l_SZZq6DejAU14VlAWu-sDU'

# Daftar Telegram User ID yang menjadi ADMIN
ADMIN_IDS = [123456789, 987654321] # <--- GANTI DENGAN USER ID TELEGRAM ADMIN ANDA!

# Nama file database
DB_FILE = '/usr/bin/jualan.db'

# --- KONFIGURASI SSH KE VPS ---
SSH_HOST = "localhost"
SSH_USERNAME = os.getenv("SSH_USERNAME", "root")
SSH_PASSWORD = os.getenv("SSH_PASSWORD", "")

# --- KONSTANTA UNTUK BIAYA AKUN ---
ACCOUNT_COST_IDR = 10000.0
ACCOUNT_DURATION_DAYS = 30

# --- LOKASI GAMBAR QRIS (FILE LOKAL) ---
QRIS_IMAGE_PATH = "/usr/bin/qris.jpg"
# URL Fallback jika pengiriman gambar lokal gagal (pastikan ini bisa diakses publik)
QRIS_IMAGE_URL_FALLBACK = "http://aws.hokagelegend.web.id:89/qris.jpg"

# --- INFORMASI KONTAK DAN GRUP ---
TELEGRAM_ADMIN_USERNAME = "HookageLegend"
WHATSAPP_ADMIN_NUMBER = "087726917005"
GROUP_TELEGRAM_LINK = "https://t.me/hokagelegend1"

# --- STATES UNTUK SEMUA CONVERSATION HANDLER (Didefinisikan secara GLOBAL di bagian paling atas) ---
# VMess
VMESS_GET_USERNAME, VMESS_GET_EXPIRED_DAYS, VMESS_GET_QUOTA, VMESS_GET_IP_LIMIT = range(4)
# Shadowsocks
SHADOWSOCKS_GET_USERNAME, SHADOWSOCKS_GET_EXPIRED_DAYS, SHADOWSOCKS_GET_QUOTA = range(4, 7)
# SSH OVPN
SSH_OVPN_GET_USERNAME, SSH_OVPN_GET_PASSWORD, SSH_OVPN_GET_EXPIRED_DAYS, SSH_OVPN_GET_QUOTA, SSH_OVPN_GET_IP_LIMIT = range(7, 12)
# Admin: Add Balance
ADD_BALANCE_GET_USER_ID, ADD_BALANCE_GET_AMOUNT = range(12, 14)
# Admin: Check Balance
CHECK_BALANCE_GET_USER_ID = range(14, 15)
# Admin: View User Transactions
VIEW_USER_TX_GET_USER_ID = range(15, 16)
# Admin: Settings
SETTINGS_MENU = range(16, 17) # State for navigating the settings menu
# VLESS
VLESS_GET_USERNAME, VLESS_GET_EXPIRED_DAYS, VLESS_GET_QUOTA, VLESS_GET_IP_LIMIT = range(17, 21)


# --- FUNGSI DATABASE ---
def get_db_connection():
    """Membuka koneksi ke database."""
    conn = sqlite3.connect(DB_FILE)
    conn.row_factory = sqlite3.Row
    return conn

def init_db():
    """Menginisialisasi database dan membuat tabel jika belum ada."""
    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS users (
            user_id INTEGER PRIMARY KEY,
            balance REAL DEFAULT 0.0,
            registered_at TEXT
        )
    ''')
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS transactions (
            transaction_id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER NOT NULL,
            type TEXT NOT NULL,
            amount REAL NOT NULL,
            timestamp TEXT NOT NULL,
            description TEXT,
            FOREIGN KEY (user_id) REFERENCES users (user_id)
        )
    ''')
    conn.commit()
    conn.close()

def get_user_balance(user_id: int) -> float:
    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute("SELECT balance FROM users WHERE user_id = ?", (user_id,))
    result = cursor.fetchone()
    conn.close()
    return result['balance'] if result else 0.0

def update_user_balance(user_id: int, amount: float, transaction_type: str, description: str, is_deduction: bool = False) -> bool:
    conn = get_db_connection()
    cursor = conn.cursor()
    try:
        current_balance_check = get_user_balance(user_id)
        if is_deduction and current_balance_check < amount:
            logger.warning(f"Deduction failed for user {user_id}: insufficient balance (current: {current_balance_check}, attempt to deduct: {amount})")
            return False

        if is_deduction:
            cursor.execute("UPDATE users SET balance = balance - ? WHERE user_id = ?", (amount, user_id))
        else:
            cursor.execute("UPDATE users SET balance = balance + ? WHERE user_id = ?", (amount, user_id))

        timestamp = DT.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        cursor.execute("INSERT INTO transactions (user_id, type, amount, timestamp, description) VALUES (?, ?, ?, ?, ?)",
                       (user_id, transaction_type, amount if not is_deduction else -amount, timestamp, description))
        conn.commit()

        return True
    except sqlite3.Error as e:
        logger.error(f"Database error updating balance for user {user_id} or logging transaction: {e}")
        conn.rollback()
        return False
    finally:
        if conn:
            conn.close()

def get_user_transactions(user_id: int, limit: int = 10) -> list[dict]:
    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute("SELECT type, amount, timestamp, description FROM transactions WHERE user_id = ? ORDER BY timestamp DESC LIMIT ?", (user_id, limit))
    transactions = cursor.fetchall()
    conn.close()
    return [dict(row) for row in transactions]

def get_all_transactions(limit: int = 20) -> list[dict]:
    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute("SELECT T.user_id, T.type, T.amount, T.timestamp, T.description FROM transactions AS T ORDER BY T.timestamp DESC LIMIT ?", (limit,))
    transactions = cursor.fetchall()
    conn.close()
    return [dict(row) for row in transactions]

# Call init_db here after function definitions
init_db()
logger.info("Database initialized.")

# --- HELPER: Cek apakah user adalah admin ---
def is_admin(user_id: int) -> bool:
    return user_id in ADMIN_IDS

# --- FUNGSI UNTUK MEMBUAT KEYBOARD MENU ---
def get_main_menu_keyboard():
    """Mengembalikan objek ReplyKeyboardMarkup untuk menu utama user biasa."""
    buttons = [
        [KeyboardButton('🚀 MENU SSH OVPN')],
        [KeyboardButton('⚡ MENU VMESS'), KeyboardButton('🌀 MENU VLESS')],
        [KeyboardButton('🛡️ MENU TROJAN'), KeyboardButton('👻 MENU SHDWSK')],
        [KeyboardButton('💳 Cek Saldo'), KeyboardButton('📜 Riwayat Transaksi')],
        [KeyboardButton('💰 TOPUP SALDO [QRIS]')],
        [KeyboardButton('🔄 REFRESH')]
    ]
    return ReplyKeyboardMarkup(buttons, resize_keyboard=True, one_time_keyboard=False)

def get_admin_main_menu_keyboard():
    """Mengembalikan objek ReplyKeyboardMarkup untuk menu utama admin."""
    buttons = [
        [KeyboardButton('🚀 MENU SSH OVPN')],
        [KeyboardButton('⚡ MENU VMESS'), KeyboardButton('🌀 MENU VLESS')],
        [KeyboardButton('🛡️ MENU TROJAN'), KeyboardButton('👻 MENU SHDWSK')],
        [KeyboardButton('🔍 CHECK SERVICE'), KeyboardButton('⚙️ Settings')], # Added Settings button
        [KeyboardButton('👥 MANAGE USERS')],
        [KeyboardButton('💰 TOPUP SALDO [QRIS]'), KeyboardButton('📜 Riwayat Transaksi Admin')],
        [KeyboardButton('🔄 REFRESH')]
    ]
    return ReplyKeyboardMarkup(buttons, resize_keyboard=True, one_time_keyboard=False)

def get_manage_users_menu_keyboard():
    """Mengembalikan ReplyKeyboardMarkup untuk sub-menu Manage Users (Admin Only)."""
    buttons = [
        [KeyboardButton('➕ Tambah Saldo Pengguna')],
        [KeyboardButton('🔎 Cek Saldo Pengguna')],
        [KeyboardButton('📜 Riwayat Transaksi Pengguna')],
        [KeyboardButton('🗑️ Hapus Pengguna')],
        [KeyboardButton('🔙 Back to Admin Menu')]
    ]
    return ReplyKeyboardMarkup(buttons, resize_keyboard=True, one_time_keyboard=False)

def get_settings_menu_keyboard():
    """Mengembalikan ReplyKeyboardMarkup untuk sub-menu Settings (Admin Only)."""
    buttons = [
        [KeyboardButton('💾 Backup VPS')],
        [KeyboardButton('👁️ Cek Koneksi Aktif')], # New button for checking connections
        [KeyboardButton('Change SSH Host (Placeholder)')], # Example setting
        [KeyboardButton('🔙 Back to Admin Menu')]
    ]
    return ReplyKeyboardMarkup(buttons, resize_keyboard=True, one_time_keyboard=False)

def get_ssh_ovpn_menu_keyboard():
    """Mengembalikan ReplyKeyboardMarkup untuk sub-menu SSH OVPN."""
    buttons = [
        [KeyboardButton('➕ CREATE AKUN SSH')],
        [KeyboardButton('ℹ️ INFO SSH OVPN')],
        [KeyboardButton('🔙 Back to Main Menu')]
    ]
    return ReplyKeyboardMarkup(buttons, resize_keyboard=True, one_time_keyboard=False)

def get_vmess_creation_menu_keyboard():
    """Mengembalikan ReplyKeyboardMarkup untuk sub-menu VMESS (pembuatan/trial)."""
    buttons = [
        [KeyboardButton('➕ CREATE AKUN VMESS')],
        [KeyboardButton('🆓 CREATE TRIAL VMESS')],
        [KeyboardButton('📊 CHECK VMESS SERVICE')],
        [KeyboardButton('🔙 Back to Main Menu')]
    ]
    return ReplyKeyboardMarkup(buttons, resize_keyboard=True, one_time_keyboard=False)

def get_vless_menu_keyboard():
    """Mengembalikan ReplyKeyboardMarkup untuk sub-menu VLESS."""
    buttons = [
        [KeyboardButton('➕ CREATE AKUN VLESS')],
        [KeyboardButton('📊 CHECK VLESS SERVICE')],
        [KeyboardButton('🔙 Back to Main Menu')]
    ]
    return ReplyKeyboardMarkup(buttons, resize_keyboard=True, one_time_keyboard=False)

def get_trojan_menu_keyboard():
    """Mengembalikan ReplyKeyboardMarkup untuk sub-menu Trojan."""
    buttons = [
        [KeyboardButton('🆓 CREATE TRIAL TROJAN')],
        [KeyboardButton('➕ CREATE AKUN TROJAN')],
        [KeyboardButton('🔙 Back to Main Menu')]
    ]
    return ReplyKeyboardMarkup(buttons, resize_keyboard=True, one_time_keyboard=False)

def get_shadowsocks_menu_keyboard():
    """Mengembalikan ReplyKeyboardMarkup untuk sub-menu Shadowsocks."""
    buttons = [
        [KeyboardButton('➕ CREATE AKUN SHDWSK')],
        [KeyboardButton('🆓 CREATE TRIAL SHDWSK')],
        [KeyboardButton('🔙 Back to Main Menu')]
    ]
    return ReplyKeyboardMarkup(buttons, resize_keyboard=True, one_time_keyboard=False)


# --- FUNGSI UNTUK MENJALANKAN PERINTAH SHELL MELALUI SSH ---
async def run_ssh_command(command: str):
    """
    Menjalankan perintah shell di VPS melalui SSH dan mengembalikan outputnya.
    Menggunakan autentikasi kata sandi.
    """
    client = paramiko.SSHClient()
    client.set_missing_host_key_policy(paramiko.AutoAddPolicy())

    try:
        client.connect(hostname=SSH_HOST, username=SSH_USERNAME, password=SSH_PASSWORD)
        logger.info(f"Executing SSH command: {command}")
        stdin, stdout, stderr = client.exec_command(command)
        output = stdout.read().decode('utf-8').strip()
        error = stderr.read().decode('utf-8').strip()

        if error:
            logger.error(f"Error from SSH command '{command}': {error}")
            return f"❌ <b>Terjadi Kesalahan di Server!</b>\n<i>Silakan hubungi administrator.</i>\n<code>{error}</code>"
        if not output:
            return "⚠️ <b>Perintah berhasil dieksekusi, namun tidak ada output.</b>"
        return output
    except paramiko.AuthenticationException:
        logger.critical("Gagal otentikasi SSH. Pastikan username dan password SSH benar.")
        return "❌ <b>Autentikasi SSH Gagal!</b>\n<i>Mohon hubungi administrator bot.</i>"
    except paramiko.SSHException as e:
        logger.critical(f"Terjadi Kesalahan SSH! Error: {e}")
        return f"❌ <b>Terjadi Kesalahan SSH!</b>\n<i>Mohon hubungi administrator bot.</i>\n<code>{e}</code>"
    except Exception as e:
        logger.critical(f"Terjadi kesalahan tak terduga saat menjalankan perintah SSH: {e}")
        return f"❌ <b>Terjadi Kesalahan Tak Terduga!</b>\n<i>Mohon hubungi administrator bot.</i>\n<code>{e}</code>"
    finally:
        if client:
            client.close()

# --- DEFINISI SEMUA HANDLER (ASYNC DEF) DI SINI ---

# Handler Perintah Umum dan Navigasi (ini bisa di awal)
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Mengirim pesan sambutan saat perintah /start diterima."""
    user_id = update.effective_user.id
    user_first_name = update.effective_user.first_name if update.effective_user.first_name else "Pengguna"
    username_tg = update.effective_user.username if update.effective_user.username else f"ID:{user_id}"

    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute("SELECT user_id FROM users WHERE user_id = ?", (user_id,))
    existing_user = cursor.fetchone()
    if existing_user:
        logger.info(f"User {username_tg} ({user_id}) already registered. Sending welcome back message with menu.")
        greeting_message = f"👋 Selamat datang kembali, <b>{user_first_name}</b>!\n" \
                           f"<i>Nikmati layanan VPN terbaik dari kami.</i>\n\n" \
                           f"Silakan pilih opsi layanan di bawah ini:"
    else:
        registered_at = DT.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        cursor.execute("INSERT INTO users (user_id, balance, registered_at) VALUES (?, ?, ?)",
                       (user_id, 0.0, registered_at))
        conn.commit()
        logger.info(f"New user registered: {username_tg} ({user_id})")
        greeting_message = f"🎉 Halo, <b>{user_first_name}</b>! Selamat datang di <b>HOKAGE LEGEND VPN STORE</b>!\n" \
                           f"Anda berhasil terdaftar di sistem kami dengan saldo awal <b>Rp 0</b>.\n\n" \
                           f"Silakan pilih opsi layanan untuk memulai:"
    conn.close()

    if is_admin(user_id):
        await update.message.reply_text(
            greeting_message + "\n\n<i>Anda masuk sebagai <b>Admin</b>.</i>",
            reply_markup=get_admin_main_menu_keyboard(), parse_mode='HTML'
        )
    else:
        await update.message.reply_text(
            greeting_message,
            reply_markup=get_main_menu_keyboard(), parse_mode='HTML'
        )

async def show_menu(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Menampilkan keyboard menu sesuai role."""
    user_id = update.effective_user.id
    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute("SELECT user_id FROM users WHERE user_id = ?", (user_id,))
    existing_user = cursor.fetchone()
    conn.close()

    if existing_user:
        if is_admin(user_id):
            await update.message.reply_text(
                'Pilih opsi layanan (Admin Panel) ⚙️:',
                reply_markup=get_admin_main_menu_keyboard()
            )
        else:
            await update.message.reply_text(
                'Pilih opsi layanan ✨:',
                reply_markup=get_main_menu_keyboard()
            )
    else:
        await update.message.reply_text('Maaf, Anda belum terdaftar. Silakan gunakan perintah /start terlebih dahulu.')

async def cancel_conversation(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """Membatalkan percakapan yang sedang berlangsung."""
    user_id = update.effective_user.id
    if is_admin(user_id):
        await update.message.reply_text(
            '✅ Operasi dibatalkan.',
            reply_markup=get_admin_main_menu_keyboard()
        )
    else:
        await update.message.reply_text(
            '✅ Operasi dibatalkan.',
            reply_markup=get_main_menu_keyboard()
        )
    context.user_data.clear()
    return ConversationHandler.END

async def unknown(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user_id = update.effective_user.id
    current_keyboard = get_admin_main_menu_keyboard() if is_admin(user_id) else get_main_menu_keyboard()
    if update.message and update.message.from_user and not update.message.from_user.is_bot:
        await update.message.reply_text(
            '❓ Maaf, saya tidak mengerti perintah itu. Silakan gunakan tombol menu atau perintah /menu.',
            reply_markup=current_keyboard
        )

async def handle_general_script_button(update: Update, context: ContextTypes.DEFAULT_TYPE, script_path: str, message_loading: str, message_error: str, return_markup: ReplyKeyboardMarkup = None) -> None:
    """
    Fungsi helper untuk menangani penekanan tombol yang akan mengeksekusi skrip SSH.
    Digunakan untuk skrip yang tidak memerlukan input interaktif.
    """
    user_id = update.effective_user.id
    if return_markup is None:
        return_markup = get_admin_main_menu_keyboard() if is_admin(user_id) else get_main_menu_keyboard()

    await update.message.reply_text(f"⏳ {message_loading}")
    result = await run_ssh_command(f"bash {script_path}")
    if "Error:" in result or "Terjadi Kesalahan di Server!" in result:
        await update.message.reply_text(f"{message_error}\n{result}", parse_mode='HTML', reply_markup=return_markup)
    else:
        await update.message.reply_text(result, parse_mode='HTML', reply_markup=return_markup)


# Handlers Navigasi Sub-Menu
async def menu_ssh_ovpn_main(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Menampilkan sub-menu SSH OVPN."""
    await update.message.reply_text(
        "➡️ Anda di Menu <b>SSH OVPN</b>. Pilih opsi:",
        reply_markup=get_ssh_ovpn_menu_keyboard(), parse_mode='HTML'
    )

async def menu_vmess_main(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Menampilkan sub-menu VMESS (untuk pembuatan/trial)."""
    await update.message.reply_text(
        "➡️ Anda di Menu <b>VMESS</b>. Pilih opsi:",
        reply_markup=get_vmess_creation_menu_keyboard(), parse_mode='HTML'
    )

async def menu_vless_main(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Menampilkan sub-menu VLESS."""
    await update.message.reply_text(
        "➡️ Anda di Menu <b>VLESS</b>. Pilih opsi:",
        reply_markup=get_vless_menu_keyboard(), parse_mode='HTML'
    )

async def menu_trojan_main(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Menampilkan sub-menu Trojan."""
    await update.message.reply_text(
        "➡️ Anda di Menu <b>TROJAN</b>. Pilih opsi:",
        reply_markup=get_trojan_menu_keyboard(), parse_mode='HTML'
    )

async def menu_shdwsk_main(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Menampilkan sub-menu Shadowsocks."""
    await update.message.reply_text(
        "➡️ Anda di Menu <b>Shadowsocks</b>. Pilih opsi:",
        reply_markup=get_shadowsocks_menu_keyboard(), parse_mode='HTML'
    )

async def back_to_main_menu(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Mengembalikan ke menu utama sesuai role."""
    user_id = update.effective_user.id
    if is_admin(user_id):
        await update.message.reply_text(
            "↩️ Kembali ke <b>Menu Utama (Admin Panel)</b>:",
            reply_markup=get_admin_main_menu_keyboard(), parse_mode='HTML'
        )
    else:
        await update.message.reply_text(
            "↩️ Kembali ke <b>Menu Utama</b>:",
            reply_markup=get_main_menu_keyboard(), parse_mode='HTML'
        )

# HANDLER UTK TOMBOL MENU UMUM (tidak memerlukan input interaktif)
async def check_vless_service_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    await handle_general_script_button(update, context, '/usr/bin/bot-cek-vless',
                                 message_loading='Memuat informasi layanan VLESS...',
                                 message_error='❌ Gagal memuat informasi layanan VLESS.',
                                 return_markup=get_vless_menu_keyboard())


async def menu_shdwsk_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    await handle_general_script_button(update, context, '/usr/bin/bot-trialss', # Menggunakan bot-trialss untuk cek
                                 message_loading='Memuat menu SHADOWSOCKS...',
                                 message_error='❌ Gagal memuat menu SHADOWSOCKS.')


# HANDLER KHUSUS ADMIN
async def check_service_admin_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user_id = update.effective_user.id
    if not is_admin(user_id):
        await update.message.reply_text("🚫 Maaf, fitur ini hanya untuk admin.", reply_markup=get_main_menu_keyboard())
        return
    await handle_general_script_button(update, context, '/usr/bin/resservice',
                                 message_loading='Memeriksa status layanan...',
                                 message_error='❌ Gagal memeriksa status layanan.',
                                 return_markup=get_admin_main_menu_keyboard())

async def other_setting_admin_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user_id = update.effective_user.id
    if not is_admin(user_id):
        await update.message.reply_text("🚫 Maaf, fitur ini hanya untuk admin.", reply_markup=get_main_menu_keyboard())
        return
    await handle_general_script_button(update, context, '/usr/bin/bot-vps-info',
                                 message_loading='Memuat informasi VPS...',
                                 message_error='❌ Gagal memuat informasi VPS.',
                                 return_markup=get_admin_main_menu_keyboard())

async def manage_users_main(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user_id = update.effective_user.id
    if not is_admin(user_id):
        await update.message.reply_text("🚫 Maaf, fitur ini hanya untuk admin.", reply_markup=get_main_menu_keyboard())
        return
    await update.message.reply_text(
        "➡️ Anda di Menu <b>Manajemen Pengguna</b>. Pilih opsi:",
        reply_markup=get_manage_users_menu_keyboard(), parse_mode='HTML'
    )

# New: Settings Menu Handler
async def settings_main_menu(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user_id = update.effective_user.id
    if not is_admin(user_id):
        await update.message.reply_text("🚫 Maaf, fitur ini hanya untuk admin.", reply_markup=get_main_menu_keyboard())
        return
    await update.message.reply_text(
        "➡️ Anda di Menu <b>Pengaturan</b>. Pilih opsi:",
        reply_markup=get_settings_menu_keyboard(), parse_mode='HTML'
    )

async def handle_change_ssh_host_placeholder(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Placeholder for changing SSH Host."""
    user_id = update.effective_user.id
    if not is_admin(user_id):
        await update.message.reply_text("🚫 Maaf, fitur ini hanya untuk admin.", reply_markup=get_main_menu_keyboard())
        return
    await update.message.reply_text(
        "⚙️ Ini adalah contoh fungsi pengaturan. Di sini Anda bisa menambahkan logika untuk mengubah konfigurasi SSH Host.",
        reply_markup=get_settings_menu_keyboard(), parse_mode='HTML'
    )

async def backup_vps_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Handles the Backup VPS button, executing the backup script."""
    user_id = update.effective_user.id
    if not is_admin(user_id):
        await update.message.reply_text("🚫 Maaf, fitur ini hanya untuk admin.", reply_markup=get_main_menu_keyboard())
        return
    
    # Call the general script handler for non-interactive scripts
    await handle_general_script_button(
        update, 
        context, 
        '/usr/bin/bot-backup', # Path to your backup script
        message_loading='Memulai proses backup VPS. Ini mungkin memakan waktu beberapa menit...',
        message_error='❌ Gagal melakukan backup VPS.',
        return_markup=get_settings_menu_keyboard() # Return to settings menu after
    )

async def check_connections_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Handles the Check Current Connections button, executing the script."""
    user_id = update.effective_user.id
    if not is_admin(user_id):
        await update.message.reply_text("🚫 Maaf, fitur ini hanya untuk admin.", reply_markup=get_main_menu_keyboard())
        return
    
    await handle_general_script_button(
        update, 
        context, 
        '/usr/bin/bot-cek-login-ssh', # Path to your check connections script
        message_loading='Memeriksa koneksi pengguna aktif. Mohon tunggu...',
        message_error='❌ Gagal memeriksa koneksi aktif. Pastikan script ada dan izin benar.',
        return_markup=get_settings_menu_keyboard() # Return to settings menu after
    )


async def create_trial_trojan_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    await handle_general_script_button(update, context, '/usr/bin/bot-trial',
                                 message_loading='Membuat akun trial Trojan...',
                                 message_error='❌ Gagal membuat akun trial Trojan.',
                                 return_markup=get_trojan_menu_keyboard())

async def create_trial_vmess_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    await handle_general_script_button(update, context, '/usr/bin/bot-trialws',
                                 message_loading='Membuat akun trial VMESS...',
                                 message_error='❌ Gagal membuat akun VMESS.',
                                 return_markup=get_vmess_creation_menu_keyboard())

async def check_vmess_service_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    await handle_general_script_button(update, context, '/usr/bin/bot-cek-vmess',
                                 message_loading='Memeriksa status VMESS...',
                                 message_error='❌ Gagal memeriksa status VMESS.',
                                 return_markup=get_vmess_creation_menu_keyboard())


async def info_ssh_ovpn_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Handler untuk tombol INFO SSH OVPN di sub-menu SSH OVPN."""
    await update.message.reply_text('ℹ️ Informasi tentang layanan SSH OVPN akan ditampilkan di sini.', reply_markup=get_ssh_ovpn_menu_keyboard())

async def create_akun_trojan_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    await update.message.reply_text('⚙️ Fitur pembuatan akun Trojan penuh akan segera tersedia.', reply_markup=get_trojan_menu_keyboard())

async def create_akun_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    await update.message.reply_text('📝 Anda memilih CREATE AKUN. Proses pembuatan akun akan dimulai.', reply_markup=get_main_menu_keyboard())

async def renew_akun_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    await update.message.reply_text('🔄 Anda memilih RENEW AKUN. Fitur perpanjangan akun akan segera dikembangkan.', reply_markup=get_main_menu_keyboard())

async def topup_saldo_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user_id = update.effective_user.id
    current_balance = get_user_balance(user_id)

    caption_text = (
        f"<b>💰 Top Up Saldo Akun VPN Anda!</b>\n"
        f"Saldo Anda saat ini: <b>Rp {current_balance:,.0f}</b>.\n\n"
        f"Untuk top up, silakan transfer ke rekening berikut:\n"
        f"<b>Nama Bank:</b> [Nama Bank Anda]\n" # <--- GANTI INI
        f"<b>Nomor Rekening:</b> [Nomor Rekening Anda]\n" # <--- GANTI INI
        f"<b>Atas Nama:</b> [Nama Pemilik Rekening]\n\n" # <--- GANTI INI
        f"Setelah transfer, silakan kirim <b>bukti transfer</b> beserta <i>Telegram User ID Anda</i> ke Admin:\n"
        f"📞 <b>Admin Telegram:</b> <a href=\"https://t.me/{TELEGRAM_ADMIN_USERNAME}\">@{TELEGRAM_ADMIN_USERNAME}</a>\n"
        f"💬 <b>Admin WhatsApp:</b> <a href=\"https://wa.me/{WHATSAPP_ADMIN_NUMBER}\">+{WHATSAPP_ADMIN_NUMBER}</a>\n\n"
        f"📢 Bergabunglah dengan Group Telegram kami untuk info terbaru:\n"
        f"<a href=\"{GROUP_TELEGRAM_LINK}\">HOKAGE LEGEND GROUP</a>\n\n"
        f"<i>Saldo akan ditambahkan secara manual oleh Admin setelah verifikasi.</i>"
    )

    reply_markup_to_send = get_main_menu_keyboard() if not is_admin(user_id) else get_admin_main_menu_keyboard()

    if os.path.exists(QRIS_IMAGE_PATH):
        try:
            with open(QRIS_IMAGE_PATH, 'rb') as photo_file:
                await update.message.reply_photo(
                    photo=InputFile(photo_file),
                    caption=caption_text,
                    parse_mode='HTML',
                    reply_markup=reply_markup_to_send
                )
        except Exception as e:
            logger.error(f"Failed to send QRIS photo from local file: {e}")
            await update.message.reply_text(
                f"⚠️ <b>Gagal menampilkan gambar QRIS dari file lokal.</b>\n"
                f"Silakan gunakan link ini untuk melihat QRIS: <a href=\"{QRIS_IMAGE_URL_FALLBACK}\">QRIS Anda</a>\n\n" + caption_text,
                parse_mode='HTML',
                reply_markup=reply_markup_to_send
            )
    else:
        logger.warning(f"QRIS image file not found at {QRIS_IMAGE_PATH}. Sending URL fallback.")
        await update.message.reply_text(
            f"⚠️ <b>Gagal menampilkan gambar QRIS. File tidak ditemukan di server.</b>\n"
            f"Silakan gunakan link ini untuk melihat QRIS: <a href=\"{QRIS_IMAGE_URL_FALLBACK}\">QRIS Anda</a>\n\n" + caption_text,
            parse_mode='HTML',
            reply_markup=reply_markup_to_send
        )

async def refresh_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    await update.message.reply_text('🔄 Data akan diperbarui.', reply_markup=get_main_menu_keyboard())

# BARU: Handler Cek Saldo untuk User Biasa
async def check_balance_user_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user_id = update.effective_user.id
    current_balance = get_user_balance(user_id)
    await update.message.reply_text(
        f"💳 <b>Saldo Anda saat ini: Rp {current_balance:,.0f}</b>.",
        parse_mode='HTML',
        reply_markup=get_main_menu_keyboard()
    )

# BARU: Handler Riwayat Transaksi untuk User Biasa
async def view_transactions_user_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user_id = update.effective_user.id
    transactions = get_user_transactions(user_id)

    if not transactions:
        message = "📜 <b>Anda belum memiliki riwayat transaksi.</b>"
    else:
        message = "📜 <b>Riwayat Transaksi Anda (10 Terbaru):</b>\n\n"
        for i, tx in enumerate(transactions):
            amount_str = f"Rp {abs(tx['amount']):,.0f}"
            sign = "+" if tx['amount'] >= 0 else ""
            message += f"<b>{i+1}.</b> <code>{tx['timestamp']}</code>\n"
            message += f"    Tipe: <i>{tx['type'].replace('_', ' ').title()}</i>\n"
            message += f"    Jumlah: {sign}{amount_str}\n"
            if tx['description']:
                message += f"    Deskripsi: <i>{tx['description']}</i>\n"
            message += "\n"
    await update.message.reply_text(message, parse_mode='HTML', reply_markup=get_main_menu_keyboard())

# FUNGSI-FUNGSI HANDLER PERCAKAPAN
# VMess Conversation Handlers
# States: VMESS_GET_USERNAME, VMESS_GET_EXPIRED_DAYS, VMESS_GET_QUOTA, VMESS_GET_IP_LIMIT (didefinisikan global)

async def create_akun_vmess_start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """Memulai percakapan untuk pembuatan akun VMESS (dipicu dari sub-menu VMESS)."""
    user_id = update.effective_user.id
    current_balance = get_user_balance(user_id)

    if current_balance < ACCOUNT_COST_IDR:
        await update.message.reply_text(
            f"🚫 <b>Saldo Anda tidak mencukupi!</b>\n"
            f"Saldo Anda saat ini: <b>Rp {current_balance:,.0f}</b>.\n"
            f"Untuk membuat akun VMESS (durasi {ACCOUNT_DURATION_DAYS} hari) dibutuhkan: <b>Rp {ACCOUNT_COST_IDR:,.0f}</b>.\n"
            "Silakan lakukan <b>TOPUP SALDO [QRIS]</b> terlebih dahulu.",
            parse_mode='HTML',
            reply_markup=get_vmess_creation_menu_keyboard()
        )
        return ConversationHandler.END
    else:
        await update.message.reply_text(
            f"✅ Saldo Anda saat ini <b>Rp {current_balance:,.0f}</b>. Biaya pembuatan akun <b>Rp {ACCOUNT_COST_IDR:,.0f}</b>.\n"
            "Saldo Anda cukup. Silakan masukkan Username:"
        )
        return VMESS_GET_USERNAME

async def vmess_get_username(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """Menerima username dan meminta masa aktif (days)."""
    username = update.message.text
    if not username:
        await update.message.reply_text("Username tidak boleh kosong. Silakan masukkan Username:")
        return VMESS_GET_USERNAME

    if not username.isalnum() and "_" not in username:
        await update.message.reply_text("Username hanya boleh mengandung huruf, angka, dan underscore (_). Silakan masukkan Username yang valid:")
        return VMESS_GET_USERNAME

    context.user_data['vmess_username'] = username
    await update.message.reply_text("Username diterima. Sekarang, masukkan Masa Aktif (dalam hari, contoh: 30 untuk 30 hari):")
    return VMESS_GET_EXPIRED_DAYS

async def vmess_get_expired_days(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """Menerima masa aktif dan meminta limit kuota (GB)."""
    expired_days_str = update.message.text
    if not expired_days_str.isdigit():
        await update.message.reply_text("Masa aktif harus berupa angka. Silakan masukkan Masa Aktif (contoh: 30):")
        return VMESS_GET_EXPIRED_DAYS

    expired_days = int(expired_days_str)
    context.user_data['vmess_expired_days'] = expired_days
    await update.message.reply_text("Masa Aktif diterima. Sekarang, masukkan Limit Kuota (dalam GB, contoh: 10 untuk 10 GB):")
    return VMESS_GET_QUOTA

async def vmess_get_quota(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """Menerima limit kuota dan meminta batas IP."""
    quota_str = update.message.text
    if not quota_str.isdigit():
        await update.message.reply_text("Limit Kuota harus berupa angka. Silakan masukkan Limit Kuota (contoh: 10):")
        return VMESS_GET_QUOTA

    quota = int(quota_str)
    context.user_data['vmess_quota'] = quota
    await update.message.reply_text("Limit Kuota diterima. Terakhir, masukkan Batas User (jumlah IP, contoh: 2 untuk 2 IP):")
    return VMESS_GET_IP_LIMIT

async def vmess_get_ip_limit(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """Menerima batas IP, menjalankan skrip, dan mengirim hasilnya."""
    user_id = update.effective_user.id
    ip_limit_str = update.message.text
    if not ip_limit_str.isdigit():
        await update.message.reply_text("Batas User (IP) harus berupa angka. Silakan masukkan Batas User (contoh: 2):")
        return VMESS_GET_IP_LIMIT

    ip_limit = int(ip_limit_str)
    context.user_data['vmess_ip_limit'] = ip_limit

    username = context.user_data['vmess_username']
    expired_days = context.user_data['vmess_expired_days']
    quota = context.user_data['vmess_quota']

    current_balance = get_user_balance(user_id)
    if current_balance < ACCOUNT_COST_IDR:
        await update.message.reply_text(
            f"🚫 <b>Saldo Anda saat ini Rp {current_balance:,.0f}.</b> Biaya pembuatan akun <b>Rp {ACCOUNT_COST_IDR:,.0f}</b>.\n"
            "Maaf, saldo Anda tidak mencukupi saat proses akhir. Mungkin ada transaksi lain.\n"
            "Silakan lakukan <b>TOPUP SALDO [QRIS]</b> terlebih dahulu.",
            parse_mode='HTML',
            reply_markup=get_vmess_creation_menu_keyboard()
        )
        context.user_data.clear()
        return ConversationHandler.END

    deduction_successful = update_user_balance(user_id, ACCOUNT_COST_IDR, 'account_creation', f"VMess account creation for {username}", is_deduction=True)

    if not deduction_successful:
        await update.message.reply_text(
            "⚠️ <b>Terjadi kesalahan saat mengurangi saldo Anda.</b> Mohon coba lagi atau hubungi administrator.",
            parse_mode='HTML',
            reply_markup=get_vmess_creation_menu_keyboard()
        )
        context.user_data.clear()
        return ConversationHandler.END

    await update.message.reply_text(
        f"✅ Saldo Anda <b>Rp {ACCOUNT_COST_IDR:,.0f}</b> telah dikurangi. Sisa saldo Anda: <b>Rp {get_user_balance(user_id):,.0f}</b>.\n"
        f"Membuat akun VMESS dengan detail:\n"
        f"Username: `{username}`\n"
        f"Masa Aktif: `{expired_days}` hari\n"
        f"Limit Kuota: `{quota}` GB\n"
        f"Batas IP: `{ip_limit}`\n"
        f"Mohon tunggu..."
    )

    command = f"bash /usr/bin/addws-bot {username} {expired_days} {quota} {ip_limit}"
    result_ssh = await run_ssh_command(command)

    if "Error:" in result_ssh or "Terjadi Kesalahan di Server!" in result_ssh:
        update_user_balance(user_id, ACCOUNT_COST_IDR, 'refund', f"Refund for failed VMess creation {username}", is_deduction=False)
        await update.message.reply_text(
            f"❌ Gagal membuat akun VMESS:\n\n{result_ssh}\n"
            f"<b>Saldo Anda telah dikembalikan.</b>",
            parse_mode='HTML', reply_markup=get_vmess_creation_menu_keyboard()
        )
    else:
        await update.message.reply_text(f"🎉 Akun VMESS berhasil dibuat!\n\n{result_ssh}", parse_mode='HTML', reply_markup=get_vmess_creation_menu_keyboard())

    context.user_data.clear()
    return ConversationHandler.END

# Shadowsocks Conversation Handlers
# SHADOWSOCKS_GET_USERNAME, SHADOWSOCKS_GET_EXPIRED_DAYS, SHADOWSOCKS_GET_QUOTA = range(4, 7) # States sudah didefinisikan di atas

async def create_akun_shdwsk_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """Memulai percakapan untuk pembuatan akun Shadowsocks."""
    user_id = update.effective_user.id
    current_balance = get_user_balance(user_id)

    if current_balance < ACCOUNT_COST_IDR: # Asumsi SS juga 10rb
        await update.message.reply_text(
            f"🚫 <b>Saldo Anda tidak mencukupi!</b>\n"
            f"Saldo Anda saat ini: <b>Rp {current_balance:,.0f}</b>.\n"
            f"Untuk membuat akun Shadowsocks (durasi {ACCOUNT_DURATION_DAYS} hari) dibutuhkan: <b>Rp {ACCOUNT_COST_IDR:,.0f}</b>.\n"
            "Silakan lakukan <b>TOPUP SALDO [QRIS]</b> terlebih dahulu.",
            parse_mode='HTML',
            reply_markup=get_shadowsocks_menu_keyboard()
        )
        return ConversationHandler.END
    else:
        await update.message.reply_text(
            f"✅ Saldo Anda saat ini <b>Rp {current_balance:,.0f}</b>. Biaya pembuatan akun <b>Rp {ACCOUNT_COST_IDR:,.0f}</b>.\n"
            "Saldo Anda cukup. Silakan masukkan Username Shadowsocks:"
        )
        return SHADOWSOCKS_GET_USERNAME

async def shdwsk_get_username(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    username = update.message.text
    if not username:
        await update.message.reply_text("Username tidak boleh kosong. Silakan masukkan Username Shadowsocks:")
        return SHADOWSOCKS_GET_USERNAME

    if not username.isalnum() and "_" not in username:
        await update.message.reply_text("Username hanya boleh mengandung huruf, angka, dan underscore (_). Silakan masukkan Username yang valid:")
        return SHADOWSOCKS_GET_USERNAME

    context.user_data['shdwsk_username'] = username
    await update.message.reply_text("Username diterima. Sekarang, masukkan Masa Aktif (dalam hari, contoh: 30 untuk 30 hari):")
    return SHADOWSOCKS_GET_EXPIRED_DAYS

async def shdwsk_get_expired_days(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    expired_days_str = update.message.text
    if not expired_days_str.isdigit():
        await update.message.reply_text("Masa aktif harus berupa angka. Silakan masukkan Masa Aktif (contoh: 30):")
        return SHADOWSOCKS_GET_EXPIRED_DAYS

    expired_days = int(expired_days_str)
    context.user_data['shdwsk_expired_days'] = expired_days
    await update.message.reply_text("Masa Aktif diterima. Sekarang, masukkan Limit Kuota (dalam GB, contoh: 10 untuk 10 GB):")
    return SHADOWSOCKS_GET_QUOTA

async def shdwsk_get_quota(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    quota_str = update.message.text
    if not quota_str.isdigit():
        await update.message.reply_text("Limit Kuota harus berupa angka. Silakan masukkan Limit Kuota (contoh: 10):")
        return ConversationHandler.END # Perbaiki: jika bukan angka, end convo

    quota = int(quota_str)
    context.user_data['shdwsk_quota'] = quota

    # Lanjut proses pembuatan akun Shadowsocks
    user_id = update.effective_user.id
    username = context.user_data['shdwsk_username']
    expired_days = context.user_data['shdwsk_expired_days']
    quota = context.user_data['shdwsk_quota']

    current_balance = get_user_balance(user_id)
    if current_balance < ACCOUNT_COST_IDR:
        await update.message.reply_text(
            f"🚫 <b>Saldo Anda saat ini Rp {current_balance:,.0f}.</b> Biaya pembuatan akun <b>Rp {ACCOUNT_COST_IDR:,.0f}</b>.\n"
            "Maaf, saldo Anda tidak mencukupi saat proses akhir. Mungkin ada transaksi lain.\n"
            "Silakan lakukan <b>TOPUP SALDO [QRIS]</b> terlebih dahulu.",
            parse_mode='HTML',
            reply_markup=get_shadowsocks_menu_keyboard()
        )
        context.user_data.clear()
        return ConversationHandler.END

    deduction_successful = update_user_balance(user_id, ACCOUNT_COST_IDR, 'account_creation', f"Shadowsocks account creation for {username}", is_deduction=True)

    if not deduction_successful:
        await update.message.reply_text(
            "⚠️ <b>Terjadi kesalahan saat mengurangi saldo Anda.</b> Mohon coba lagi atau hubungi administrator.",
            parse_mode='HTML',
            reply_markup=get_shadowsocks_menu_keyboard()
        )
        context.user_data.clear()
        return ConversationHandler.END

    await update.message.reply_text(
        f"✅ Saldo Anda <b>Rp {ACCOUNT_COST_IDR:,.0f}</b> telah dikurangi. Sisa saldo Anda: <b>Rp {get_user_balance(user_id):,.0f}</b>.\n"
        f"Membuat akun Shadowsocks dengan detail:\n"
        f"Username: `{username}`\n"
        f"Masa Aktif: `{expired_days}` hari\n"
        f"Limit Kuota: `{quota}` GB\n"
        f"Mohon tunggu..."
    )

    command = f"bash /usr/bin/addss-bot {username} {expired_days} {quota}" # addss-bot hanya 3 argumen
    result_ssh = await run_ssh_command(command)

    if "Error:" in result_ssh or "Terjadi Kesalahan di Server!" in result_ssh:
        update_user_balance(user_id, ACCOUNT_COST_IDR, 'refund', f"Refund for failed Shadowsocks creation {username}", is_deduction=False)
        await update.message.reply_text(
            f"❌ Gagal membuat akun Shadowsocks:\n\n{result_ssh}\n"
            f"<b>Saldo Anda telah dikembalikan.</b>",
            parse_mode='HTML', reply_markup=get_shadowsocks_menu_keyboard()
        )
    else:
        await update.message.reply_text(f"🎉 Akun Shadowsocks berhasil dibuat!\n\n{result_ssh}", parse_mode='HTML', reply_markup=get_shadowsocks_menu_keyboard())

    context.user_data.clear()
    return ConversationHandler.END

# SSH OVPN Conversation Handlers
async def create_akun_ssh_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """Memulai percakapan untuk pembuatan akun SSH OVPN."""
    user_id = update.effective_user.id
    current_balance = get_user_balance(user_id)

    if current_balance < ACCOUNT_COST_IDR:
        await update.message.reply_text(
            f"🚫 <b>Saldo Anda tidak mencukupi!</b>\n"
            f"Saldo Anda saat ini: <b>Rp {current_balance:,.0f}</b>.\n"
            f"Untuk membuat akun SSH OVPN (durasi {ACCOUNT_DURATION_DAYS} hari) dibutuhkan: <b>Rp {ACCOUNT_COST_IDR:,.0f}</b>.\n"
            "Silakan lakukan <b>TOPUP SALDO [QRIS]</b> terlebih dahulu.",
            parse_mode='HTML',
            reply_markup=get_ssh_ovpn_menu_keyboard()
        )
        return ConversationHandler.END
    else:
        await update.message.reply_text(
            f"✅ Saldo Anda saat ini <b>Rp {current_balance:,.0f}</b>. Biaya pembuatan akun <b>Rp {ACCOUNT_COST_IDR:,.0f}</b>.\n"
            "Saldo Anda cukup. Silakan masukkan Username SSH OVPN:"
        )
        return SSH_OVPN_GET_USERNAME

async def ssh_ovpn_get_username(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """Menerima username dan meminta password."""
    username = update.message.text
    if not username:
        await update.message.reply_text("Username tidak boleh kosong. Silakan masukkan Username SSH OVPN:")
        return SSH_OVPN_GET_USERNAME

    if not username.isalnum() and "_" not in username:
        await update.message.reply_text("Username hanya boleh mengandung huruf, angka, dan underscore (_). Silakan masukkan Username yang valid:")
        return SSH_OVPN_GET_USERNAME

    context.user_data['ssh_ovpn_username'] = username
    await update.message.reply_text("Username diterima. Sekarang, masukkan Password SSH OVPN:")
    return SSH_OVPN_GET_PASSWORD

async def ssh_ovpn_get_password(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """Menerima password dan meminta masa aktif."""
    password = update.message.text
    if not password:
        await update.message.reply_text("Password tidak boleh kosong. Silakan masukkan Password SSH OVPN:")
        return SSH_OVPN_GET_PASSWORD

    context.user_data['ssh_ovpn_password'] = password
    await update.message.reply_text("Password diterima. Sekarang, masukkan Masa Aktif (dalam hari, contoh: 30 untuk 30 hari):")
    return SSH_OVPN_GET_EXPIRED_DAYS

async def ssh_ovpn_get_expired_days(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """Menerima masa aktif dan meminta limit kuota."""
    expired_days_str = update.message.text
    if not expired_days_str.isdigit():
        await update.message.reply_text("Masa aktif harus berupa angka. Silakan masukkan Masa Aktif (contoh: 30):")
        return SSH_OVPN_GET_EXPIRED_DAYS

    expired_days = int(expired_days_str)
    context.user_data['ssh_ovpn_expired_days'] = expired_days
    await update.message.reply_text("Masa Aktif diterima. Sekarang, masukkan Limit Kuota (dalam GB, contoh: 10 untuk 10 GB):")
    return SSH_OVPN_GET_QUOTA

async def ssh_ovpn_get_quota(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """Menerima limit kuota dan meminta batas IP."""
    quota_str = update.message.text
    if not quota_str.isdigit():
        await update.message.reply_text("Limit Kuota harus berupa angka. Silakan masukkan Limit Kuota (contoh: 10):")
        return SSH_OVPN_GET_QUOTA

    quota = int(quota_str)
    context.user_data['ssh_ovpn_quota'] = quota
    await update.message.reply_text("Limit Kuota diterima. Terakhir, masukkan Batas User (jumlah IP, contoh: 2 untuk 2 IP):")
    return SSH_OVPN_GET_IP_LIMIT

async def ssh_ovpn_get_ip_limit(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """Menerima batas IP, menjalankan skrip, dan mengirim hasilnya."""
    user_id = update.effective_user.id
    ip_limit_str = update.message.text
    if not ip_limit_str.isdigit():
        await update.message.reply_text("Batas User (IP) harus berupa angka. Silakan masukkan Batas User (contoh: 2):")
        return SSH_OVPN_GET_IP_LIMIT

    ip_limit = int(ip_limit_str)
    context.user_data['ssh_ovpn_ip_limit'] = ip_limit

    username = context.user_data['ssh_ovpn_username']
    password = context.user_data['ssh_ovpn_password']
    expired_days = context.user_data['ssh_ovpn_expired_days']
    quota = context.user_data['ssh_ovpn_quota']

    current_balance = get_user_balance(user_id)
    if current_balance < ACCOUNT_COST_IDR:
        await update.message.reply_text(
            f"🚫 <b>Saldo Anda saat ini Rp {current_balance:,.0f}.</b> Biaya pembuatan akun <b>Rp {ACCOUNT_COST_IDR:,.0f}</b>.\n"
            "Maaf, saldo Anda tidak mencukupi saat proses akhir. Mungkin ada transaksi lain.\n"
            "Silakan lakukan <b>TOPUP SALDO [QRIS]</b> terlebih dahulu.",
            parse_mode='HTML',
            reply_markup=get_ssh_ovpn_menu_keyboard()
        )
        context.user_data.clear()
        return ConversationHandler.END

    deduction_successful = update_user_balance(user_id, ACCOUNT_COST_IDR, 'account_creation', f"SSH OVPN account creation for {username}", is_deduction=True)

    if not deduction_successful:
        await update.message.reply_text(
            "⚠️ <b>Terjadi kesalahan saat mengurangi saldo Anda.</b> Mohon coba lagi atau hubungi administrator.",
            parse_mode='HTML',
            reply_markup=get_ssh_ovpn_menu_keyboard()
        )
        context.user_data.clear()
        return ConversationHandler.END

    await update.message.reply_text(
        f"✅ Saldo Anda <b>Rp {ACCOUNT_COST_IDR:,.0f}</b> telah dikurangi. Sisa saldo Anda: <b>Rp {get_user_balance(user_id):,.0f}</b>.\n"
        f"Membuat akun SSH OVPN dengan detail:\n"
        f"Username: `{username}`\n"
        f"Password: `{password}`\n"
        f"Masa Aktif: `{expired_days}` hari\n"
        f"Limit Kuota: `{quota}` GB\n"
        f"Batas IP: `{ip_limit}`\n"
        f"Mohon tunggu..."
    )

    command = f"bash /usr/bin/addssh-bot {username} {password} {expired_days} {quota} {ip_limit}"
    result_ssh = await run_ssh_command(command)

    if "Error:" in result_ssh or "Terjadi Kesalahan di Server!" in result_ssh:
        update_user_balance(user_id, ACCOUNT_COST_IDR, 'refund', f"Refund for failed SSH OVPN creation {username}", is_deduction=False)
        await update.message.reply_text(
            f"❌ Gagal membuat akun SSH OVPN:\n\n{result_ssh}\n"
            f"<b>Saldo Anda telah dikembalikan.</b>",
            parse_mode='HTML', reply_markup=get_ssh_ovpn_menu_keyboard()
        )
    else:
        await update.message.reply_text(f"🎉 Akun SSH OVPN berhasil dibuat!\n\n{result_ssh}", parse_mode='HTML', reply_markup=get_ssh_ovpn_menu_keyboard())

    context.user_data.clear()
    return ConversationHandler.END

# VLESS Conversation Handlers
async def create_akun_vless_start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """Memulai percakapan untuk pembuatan akun VLESS."""
    user_id = update.effective_user.id
    current_balance = get_user_balance(user_id)

    if current_balance < ACCOUNT_COST_IDR:
        await update.message.reply_text(
            f"🚫 <b>Saldo Anda tidak mencukupi!</b>\n"
            f"Saldo Anda saat ini: <b>Rp {current_balance:,.0f}</b>.\n"
            f"Untuk membuat akun VLESS (durasi {ACCOUNT_DURATION_DAYS} hari) dibutuhkan: <b>Rp {ACCOUNT_COST_IDR:,.0f}</b>.\n"
            "Silakan lakukan <b>TOPUP SALDO [QRIS]</b> terlebih dahulu.",
            parse_mode='HTML',
            reply_markup=get_vless_menu_keyboard()
        )
        return ConversationHandler.END
    else:
        await update.message.reply_text(
            f"✅ Saldo Anda saat ini <b>Rp {current_balance:,.0f}</b>. Biaya pembuatan akun <b>Rp {ACCOUNT_COST_IDR:,.0f}</b>.\n"
            "Saldo Anda cukup. Silakan masukkan Username VLESS:"
        )
        return VLESS_GET_USERNAME

async def vless_get_username(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """Menerima username dan meminta masa aktif (days) untuk VLESS."""
    username = update.message.text
    if not username:
        await update.message.reply_text("Username tidak boleh kosong. Silakan masukkan Username VLESS:")
        return VLESS_GET_USERNAME

    if not username.isalnum() and "_" not in username:
        await update.message.reply_text("Username hanya boleh mengandung huruf, angka, dan underscore (_). Silakan masukkan Username yang valid:")
        return VLESS_GET_USERNAME

    context.user_data['vless_username'] = username
    await update.message.reply_text("Username diterima. Sekarang, masukkan Masa Aktif (dalam hari, contoh: 30 untuk 30 hari):")
    return VLESS_GET_EXPIRED_DAYS

async def vless_get_expired_days(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """Menerima masa aktif dan meminta limit kuota (GB) untuk VLESS."""
    expired_days_str = update.message.text
    if not expired_days_str.isdigit():
        await update.message.reply_text("Masa aktif harus berupa angka. Silakan masukkan Masa Aktif (contoh: 30):")
        return VLESS_GET_EXPIRED_DAYS

    expired_days = int(expired_days_str)
    context.user_data['vless_expired_days'] = expired_days
    await update.message.reply_text("Masa Aktif diterima. Sekarang, masukkan Limit Kuota (dalam GB, contoh: 10 untuk 10 GB):")
    return VLESS_GET_QUOTA

async def vless_get_quota(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """Menerima limit kuota dan meminta batas IP untuk VLESS."""
    quota_str = update.message.text
    if not quota_str.isdigit():
        await update.message.reply_text("Limit Kuota harus berupa angka. Silakan masukkan Limit Kuota (contoh: 10):")
        return VLESS_GET_QUOTA

    quota = int(quota_str)
    context.user_data['vless_quota'] = quota
    await update.message.reply_text("Limit Kuota diterima. Terakhir, masukkan Batas User (jumlah IP, contoh: 2 untuk 2 IP):")
    return VLESS_GET_IP_LIMIT

async def vless_get_ip_limit(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """Menerima batas IP, menjalankan skrip, dan mengirim hasilnya untuk VLESS."""
    user_id = update.effective_user.id
    ip_limit_str = update.message.text
    if not ip_limit_str.isdigit():
        await update.message.reply_text("Batas User (IP) harus berupa angka. Silakan masukkan Batas User (contoh: 2):")
        return VLESS_GET_IP_LIMIT

    ip_limit = int(ip_limit_str)
    context.user_data['vless_ip_limit'] = ip_limit

    username = context.user_data['vless_username']
    expired_days = context.user_data['vless_expired_days']
    quota = context.user_data['vless_quota']

    current_balance = get_user_balance(user_id)
    if current_balance < ACCOUNT_COST_IDR:
        await update.message.reply_text(
            f"🚫 <b>Saldo Anda saat ini Rp {current_balance:,.0f}.</b> Biaya pembuatan akun <b>Rp {ACCOUNT_COST_IDR:,.0f}</b>.\n"
            "Maaf, saldo Anda tidak mencukupi saat proses akhir. Mungkin ada transaksi lain.\n"
            "Silakan lakukan <b>TOPUP SALDO [QRIS]</b> terlebih dahulu.",
            parse_mode='HTML',
            reply_markup=get_vless_menu_keyboard()
        )
        context.user_data.clear()
        return ConversationHandler.END

    deduction_successful = update_user_balance(user_id, ACCOUNT_COST_IDR, 'account_creation', f"VLESS account creation for {username}", is_deduction=True)

    if not deduction_successful:
        await update.message.reply_text(
            "⚠️ <b>Terjadi kesalahan saat mengurangi saldo Anda.</b> Mohon coba lagi atau hubungi administrator.",
            parse_mode='HTML',
            reply_markup=get_vless_menu_keyboard()
        )
        context.user_data.clear()
        return ConversationHandler.END

    await update.message.reply_text(
        f"✅ Saldo Anda <b>Rp {ACCOUNT_COST_IDR:,.0f}</b> telah dikurangi. Sisa saldo Anda: <b>Rp {get_user_balance(user_id):,.0f}</b>.\n"
        f"Membuat akun VLESS dengan detail:\n"
        f"Username: `{username}`\n"
        f"Masa Aktif: `{expired_days}` hari\n"
        f"Limit Kuota: `{quota}` GB\n"
        f"Batas IP: `{ip_limit}`\n"
        f"Mohon tunggu..."
    )

    command = f"bash /usr/bin/addvless-bot {username} {expired_days} {quota} {ip_limit}"
    result_ssh = await run_ssh_command(command)

    if "Error:" in result_ssh or "Terjadi Kesalahan di Server!" in result_ssh:
        update_user_balance(user_id, ACCOUNT_COST_IDR, 'refund', f"Refund for failed VLESS creation {username}", is_deduction=False)
        await update.message.reply_text(
            f"❌ Gagal membuat akun VLESS:\n\n{result_ssh}\n"
            f"<b>Saldo Anda telah dikembalikan.</b>",
            parse_mode='HTML', reply_markup=get_vless_menu_keyboard()
        )
    else:
        await update.message.reply_text(f"🎉 Akun VLESS berhasil dibuat!\n\n{result_ssh}", parse_mode='HTML', reply_markup=get_vless_menu_keyboard())

    context.user_data.clear()
    return ConversationHandler.END


# Admin: Add Balance Conversation Handlers
# ADD_BALANCE_GET_USER_ID, ADD_BALANCE_GET_AMOUNT (states defined global)

async def add_balance_conversation_start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """Memulai percakapan untuk menambah saldo pengguna (admin only)."""
    user_id = update.effective_user.id
    if not is_admin(user_id):
        await update.message.reply_text("🚫 Maaf, fitur ini hanya untuk admin.", reply_markup=get_main_menu_keyboard())
        return ConversationHandler.END

    await update.message.reply_text("Silakan masukkan <b>User ID</b> pengguna yang ingin ditambahkan saldonya:", parse_mode='HTML')
    return ADD_BALANCE_GET_USER_ID

async def add_balance_get_user_id_step(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    user_input_id = update.message.text
    if not user_input_id.isdigit():
        await update.message.reply_text("❌ User ID harus berupa angka. Silakan masukkan User ID yang valid:")
        return ADD_BALANCE_GET_USER_ID

    target_user_id = int(user_input_id)

    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute("SELECT user_id FROM users WHERE user_id = ?", (target_user_id,))
    target_user_exists = cursor.fetchone()
    conn.close()

    if not target_user_exists:
        await update.message.reply_text(f"❌ User ID <b>{target_user_id}</b> tidak ditemukan dalam database. Pastikan user telah menggunakan bot sebelumnya.", parse_mode='HTML', reply_markup=get_manage_users_menu_keyboard())
        context.user_data.clear()
        return ConversationHandler.END

    context.user_data['target_user_id_for_balance'] = target_user_id
    await update.message.reply_text(f"✅ User ID <b>{target_user_id}</b> ditemukan.\nSilakan masukkan <b>jumlah saldo</b> yang ingin ditambahkan (contoh: 50000):", parse_mode='HTML')
    return ADD_BALANCE_GET_AMOUNT

async def add_balance_get_amount_step(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    amount_str = update.message.text
    if not amount_str.replace('.', '', 1).isdigit():
        await update.message.reply_text("❌ Jumlah saldo harus berupa angka. Silakan masukkan jumlah yang valid:")
        return ADD_BALANCE_GET_AMOUNT

    amount = float(amount_str)
    if amount <= 0:
        await update.message.reply_text("❌ Jumlah saldo harus lebih dari nol. Silakan masukkan jumlah yang valid:")
        return ADD_BALANCE_GET_AMOUNT

    target_user_id = context.user_data.get('target_user_id_for_balance')
    if target_user_id is None:
        await update.message.reply_text("⚠️ Terjadi kesalahan. User ID target tidak ditemukan. Mohon ulangi proses.", reply_markup=get_manage_users_menu_keyboard())
        context.user_data.clear()
        return ConversationHandler.END

    if update_user_balance(target_user_id, amount, 'topup_admin', f"Topup by admin {update.effective_user.id}"):
        await update.message.reply_text(
            f"✅ Saldo untuk user <b>{target_user_id}</b> berhasil ditambahkan sebesar <b>Rp {amount:,.0f}</b>.\n"
            f"Saldo baru user: <b>Rp {get_user_balance(target_user_id):,.0f}</b>",
            parse_mode='HTML',
            reply_markup=get_manage_users_menu_keyboard()
        )
    else:
        await update.message.reply_text("❌ Terjadi kesalahan saat menambahkan saldo ke database.", reply_markup=get_manage_users_menu_keyboard())

    context.user_data.clear()
    return ConversationHandler.END

# Admin: Check User Balance Conversation Handlers
# CHECK_BALANCE_GET_USER_ID = range(1) # States sudah didefinisikan di atas

async def check_user_balance_conversation_start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    user_id = update.effective_user.id
    if not is_admin(user_id):
        await update.message.reply_text("🚫 Maaf, fitur ini hanya untuk admin.", reply_markup=get_main_menu_keyboard())
        return ConversationHandler.END

    await update.message.reply_text("Silakan masukkan <b>User ID</b> pengguna yang ingin dicek saldonya:", parse_mode='HTML')
    return CHECK_BALANCE_GET_USER_ID

async def check_user_balance_get_user_id_step(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    user_input_id = update.message.text
    if not user_input_id.isdigit():
        await update.message.reply_text("❌ User ID harus berupa angka. Silakan masukkan User ID yang valid:")
        return CHECK_BALANCE_GET_USER_ID

    target_user_id = int(user_input_id)
    target_balance = get_user_balance(target_user_id)

    if target_balance is not None:
        await update.message.reply_text(
            f"✅ Saldo user <b>{target_user_id}</b> saat ini: <b>Rp {target_balance:,.0f}</b>.",
            parse_mode='HTML',
            reply_markup=get_manage_users_menu_keyboard()
        )
    else:
        await update.message.reply_text(
            f"❌ User ID <b>{target_user_id}</b> tidak ditemukan dalam database. Pastikan user telah menggunakan bot sebelumnya.",
            parse_mode='HTML',
            reply_markup=get_manage_users_menu_keyboard()
        )
    context.user_data.clear()
    return ConversationHandler.END

# Admin: View User Transactions Conversation Handlers
# VIEW_USER_TX_GET_USER_ID = range(1) # States sudah didefinisikan di atas

async def view_user_tx_conversation_start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    user_id = update.effective_user.id
    if not is_admin(user_id):
        await update.message.reply_text("🚫 Maaf, fitur ini hanya untuk admin.", reply_markup=get_main_menu_keyboard())
        return ConversationHandler.END

    await update.message.reply_text("Silakan masukkan <b>User ID</b> pengguna yang ingin dilihat riwayat transaksinya:", parse_mode='HTML')
    return VIEW_USER_TX_GET_USER_ID

async def view_user_tx_get_user_id_step(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    user_input_id = update.message.text
    if not user_input_id.isdigit():
        await update.message.reply_text("❌ User ID harus berupa angka. Silakan masukkan User ID yang valid:")
        return VIEW_USER_TX_GET_USER_ID

    target_user_id = int(user_input_id)
    transactions = get_user_transactions(target_user_id)

    if not transactions:
        message = f"📜 <b>User ID {target_user_id} belum memiliki riwayat transaksi.</b>"
    else:
        message = f"📜 <b>Riwayat Transaksi User {target_user_id} (10 Terbaru):</b>\n\n"
        for i, tx in enumerate(transactions):
            amount_str = f"Rp {abs(tx['amount']):,.0f}"
            sign = "+" if tx['amount'] >= 0 else ""
            message += f"<b>{i+1}.</b> <code>{tx['timestamp']}</code>\n"
            message += f"    Tipe: <i>{tx['type'].replace('_', ' ').title()}</i>\n"
            message += f"    Jumlah: {sign}{amount_str}\n"
            if tx['description']:
                message += f"    Deskripsi: <i>{tx['description']}</i>\n"
            message += "\n"

    await update.message.reply_text(message, parse_mode='HTML', reply_markup=get_manage_users_menu_keyboard())
    context.user_data.clear()
    return ConversationHandler.END


# Handler untuk Admin: Riwayat Transaksi Global
async def view_all_transactions_admin_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user_id = update.effective_user.id
    if not is_admin(user_id):
        await update.message.reply_text("🚫 Maaf, fitur ini hanya untuk admin.", reply_markup=get_main_menu_keyboard())
        return

    transactions = get_all_transactions()

    if not transactions:
        message = "📜 <b>Belum ada riwayat transaksi global.</b>"
    else:
        message = "📜 <b>Riwayat Semua Transaksi (20 Terbaru):</b>\n\n"
        for i, tx in enumerate(transactions):
            amount_str = f"Rp {abs(tx['amount']):,.0f}"
            sign = "+" if tx['amount'] >= 0 else ""
            message += f"<b>{i+1}. User {tx['user_id']}</b> <code>{tx['timestamp']}</code>\n"
            message += f"    Tipe: <i>{tx['type'].replace('_', ' ').title()}</i>\n"
            message += f"    Jumlah: {sign}{amount_str}\n"
            if tx['description']:
                message += f"    Deskripsi: <i>{tx['description']}</i>\n"
            message += "\n"

    await update.message.reply_text(message, parse_mode='HTML', reply_markup=get_admin_main_menu_keyboard())


# CommandHandler untuk Admin: Tambah Saldo (Opsional, tetap ada sebagai alternatif /add_balance)
async def admin_add_balance_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user_id = update.effective_user.id
    if not is_admin(user_id):
        await update.message.reply_text("🚫 Maaf, perintah ini hanya untuk admin.", reply_markup=get_main_menu_keyboard())
        return

    args = context.args
    if len(args) != 2 or not args[0].isdigit() or not args[1].replace('.', '', 1).isdigit():
        await update.message.reply_text("⚠️ Penggunaan: /add_balance &lt;user_id&gt; &lt;jumlah_saldo_ditambah&gt;\nContoh: /add_balance 123456789 50000", parse_mode='HTML', reply_markup=get_admin_main_menu_keyboard())
        return

    target_user_id = int(args[0])
    amount = float(args[1])

    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute("SELECT user_id FROM users WHERE user_id = ?", (target_user_id,))
    target_user_exists = cursor.fetchone()
    conn.close()

    if not target_user_exists:
        await update.message.reply_text(f"❌ User ID <b>{target_user_id}</b> tidak ditemukan dalam database. Pastikan user telah menggunakan bot sebelumnya.", parse_mode='HTML', reply_markup=get_admin_main_menu_keyboard())
        return

    if update_user_balance(target_user_id, amount, 'topup_command', f"Topup by admin command {update.effective_user.id}"):
        await update.message.reply_text(
            f"✅ Saldo untuk user <b>{target_user_id}</b> berhasil ditambahkan sebesar <b>Rp {amount:,.0f}</b>.\n"
            f"Saldo baru user: <b>Rp {get_user_balance(target_user_id):,.0f}</b>",
            parse_mode='HTML', reply_markup=get_admin_main_menu_keyboard()
        )
    else:
        await update.message.reply_text("❌ Terjadi kesalahan saat menambahkan saldo.", reply_markup=get_admin_main_menu_keyboard())


# Fallback Handler (paling akhir)
async def unknown(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user_id = update.effective_user.id
    current_keyboard = get_admin_main_menu_keyboard() if is_admin(user_id) else get_main_menu_keyboard()
    if update.message and update.message.from_user and not update.message.from_user.is_bot:
        await update.message.reply_text(
            '❓ Maaf, saya tidak mengerti perintah itu. Silakan gunakan tombol menu atau perintah /menu.',
            reply_markup=current_keyboard
        )

# --- FUNGSI UTAMA UNTUK MEMULAI BOT ---
def main() -> None:
    """Fungsi utama untuk memulai bot."""
    logger.info("Bot is starting...")

    # Validasi awal untuk kredensial SSH
    if not SSH_USERNAME:
        logger.error("Variabel lingkungan SSH_USERNAME tidak disetel atau kosong.")
        exit(1)
    if not SSH_PASSWORD:
        logger.critical("Variabel lingkungan SSH_PASSWORD tidak disetel atau kosong. Bot tidak dapat memulai SSH.")
        exit(1)

    application = Application.builder().token(BOT_TOKEN).build()

    # --- Pendaftaran semua handler ke application ---

    # Handler Perintah Umum
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("menu", show_menu))

    # Navigasi Menu Utama ke Sub-menu
    application.add_handler(MessageHandler(filters.Regex(r'^🚀 MENU SSH OVPN$'), menu_ssh_ovpn_main))
    application.add_handler(MessageHandler(filters.Regex(r'^⚡ MENU VMESS$'), menu_vmess_main))
    application.add_handler(MessageHandler(filters.Regex(r'^🌀 MENU VLESS$'), menu_vless_main))
    application.add_handler(MessageHandler(filters.Regex(r'^🛡️ MENU TROJAN$'), menu_trojan_main))
    application.add_handler(MessageHandler(filters.Regex(r'^👻 MENU SHDWSK$'), menu_shdwsk_main))

    # Tombol 'Back'
    application.add_handler(MessageHandler(filters.Regex(r'^🔙 Back to Main Menu$'), back_to_main_menu))
    application.add_handler(MessageHandler(filters.Regex(r'^🔙 Back to Admin Menu$'), back_to_main_menu))

    # Handlers untuk tombol di Sub-Menu Trojan
    application.add_handler(MessageHandler(filters.Regex(r'^🆓 CREATE TRIAL TROJAN$'), create_trial_trojan_handler))
    application.add_handler(MessageHandler(filters.Regex(r'^➕ CREATE AKUN TROJAN$'), create_akun_trojan_handler))

    # Handlers untuk tombol di Sub-Menu VMESS
    application.add_handler(MessageHandler(filters.Regex(r'^🆓 CREATE TRIAL VMESS$'), create_trial_vmess_handler))
    application.add_handler(MessageHandler(filters.Regex(r'^📊 CHECK VMESS SERVICE$'), check_vmess_service_handler))

    # Handlers untuk tombol di Sub-Menu VLESS
    application.add_handler(MessageHandler(filters.Regex(r'^📊 CHECK VLESS SERVICE$'), check_vless_service_handler))

    # Handlers untuk tombol di Sub-Menu SSH OVPN
    application.add_handler(MessageHandler(filters.Regex(r'^ℹ️ INFO SSH OVPN$'), info_ssh_ovpn_handler))

    # SSH OVPN Conversation Handler
    ssh_ovpn_conv_handler = ConversationHandler(
        entry_points=[MessageHandler(filters.Regex(r'^➕ CREATE AKUN SSH$'), create_akun_ssh_handler)],
        states={
            SSH_OVPN_GET_USERNAME: [MessageHandler(filters.TEXT & ~filters.COMMAND, ssh_ovpn_get_username)],
            SSH_OVPN_GET_PASSWORD: [MessageHandler(filters.TEXT & ~filters.COMMAND, ssh_ovpn_get_password)],
            SSH_OVPN_GET_EXPIRED_DAYS: [MessageHandler(filters.TEXT & ~filters.COMMAND, ssh_ovpn_get_expired_days)],
            SSH_OVPN_GET_QUOTA: [MessageHandler(filters.TEXT & ~filters.COMMAND, ssh_ovpn_get_quota)],
            SSH_OVPN_GET_IP_LIMIT: [MessageHandler(filters.TEXT & ~filters.COMMAND, ssh_ovpn_get_ip_limit)],
        },
        fallbacks=[CommandHandler("cancel", cancel_conversation), MessageHandler(filters.COMMAND, cancel_conversation)],
        allow_reentry=True
    )
    application.add_handler(ssh_ovpn_conv_handler)

    # General (old placement, now mostly for SHDWSK unless moved)
    application.add_handler(MessageHandler(filters.Regex(r'^👻 MENU SHDWSK$'), menu_shdwsk_handler))

    # Handlers KHUSUS ADMIN
    application.add_handler(MessageHandler(filters.Regex(r'^🔍 CHECK SERVICE$'), check_service_admin_handler))
    application.add_handler(MessageHandler(filters.Regex(r'^👥 MANAGE USERS$'), manage_users_main))
    application.add_handler(MessageHandler(filters.Regex(r'^📜 Riwayat Transaksi Admin$'), view_all_transactions_admin_handler))

    # New: Settings menu and its handlers
    application.add_handler(MessageHandler(filters.Regex(r'^⚙️ Settings$'), settings_main_menu))
    application.add_handler(MessageHandler(filters.Regex(r'^Change SSH Host \(Placeholder\)$'), handle_change_ssh_host_placeholder))
    application.add_handler(MessageHandler(filters.Regex(r'^💾 Backup VPS$'), backup_vps_handler))
    application.add_handler(MessageHandler(filters.Regex(r'^👁️ Cek Koneksi Aktif$'), check_connections_handler)) # New connection checker handler

    # Handlers untuk User Biasa (Cek Saldo & Riwayat Transaksi)
    application.add_handler(MessageHandler(filters.Regex(r'^💳 Cek Saldo$'), check_balance_user_handler))
    application.add_handler(MessageHandler(filters.Regex(r'^📜 Riwayat Transaksi$'), view_transactions_user_handler))

    # Handler TOPUP dan REFRESH
    application.add_handler(MessageHandler(filters.Regex(r'^💰 TOPUP SALDO \[QRIS\]$'), topup_saldo_handler))
    application.add_handler(MessageHandler(filters.Regex(r'^🔄 REFRESH$'), refresh_handler))

    # --- CONVERSATION HANDLERS (Didefinisikan setelah semua handler step-nya) ---
    # VMess Conversation Handler
    vmess_conv_handler = ConversationHandler(
        entry_points=[MessageHandler(filters.Regex(r'^➕ CREATE AKUN VMESS$'), create_akun_vmess_start)],
        states={
            VMESS_GET_USERNAME: [MessageHandler(filters.TEXT & ~filters.COMMAND, vmess_get_username)],
            VMESS_GET_EXPIRED_DAYS: [MessageHandler(filters.TEXT & ~filters.COMMAND, vmess_get_expired_days)],
            VMESS_GET_QUOTA: [MessageHandler(filters.TEXT & ~filters.COMMAND, vmess_get_quota)],
            VMESS_GET_IP_LIMIT: [MessageHandler(filters.TEXT & ~filters.COMMAND, vmess_get_ip_limit)],
        },
        fallbacks=[CommandHandler("cancel", cancel_conversation), MessageHandler(filters.COMMAND, cancel_conversation)],
        allow_reentry=True
    )
    application.add_handler(vmess_conv_handler)

    # VLESS Conversation Handler
    vless_conv_handler = ConversationHandler(
        entry_points=[MessageHandler(filters.Regex(r'^➕ CREATE AKUN VLESS$'), create_akun_vless_start)],
        states={
            VLESS_GET_USERNAME: [MessageHandler(filters.TEXT & ~filters.COMMAND, vless_get_username)],
            VLESS_GET_EXPIRED_DAYS: [MessageHandler(filters.TEXT & ~filters.COMMAND, vless_get_expired_days)],
            VLESS_GET_QUOTA: [MessageHandler(filters.TEXT & ~filters.COMMAND, vless_get_quota)],
            VLESS_GET_IP_LIMIT: [MessageHandler(filters.TEXT & ~filters.COMMAND, vless_get_ip_limit)],
        },
        fallbacks=[CommandHandler("cancel", cancel_conversation), MessageHandler(filters.COMMAND, cancel_conversation)],
        allow_reentry=True
    )
    application.add_handler(vless_conv_handler)

    # Shadowsocks Conversation Handler
    shadowsocks_conv_handler = ConversationHandler(
        entry_points=[MessageHandler(filters.Regex(r'^➕ CREATE AKUN SHDWSK$'), create_akun_shdwsk_handler)],
        states={
            SHADOWSOCKS_GET_USERNAME: [MessageHandler(filters.TEXT & ~filters.COMMAND, shdwsk_get_username)],
            SHADOWSOCKS_GET_EXPIRED_DAYS: [MessageHandler(filters.TEXT & ~filters.COMMAND, shdwsk_get_expired_days)],
            SHADOWSOCKS_GET_QUOTA: [MessageHandler(filters.TEXT & ~filters.COMMAND, shdwsk_get_quota)],
        },
        fallbacks=[CommandHandler("cancel", cancel_conversation), MessageHandler(filters.COMMAND, cancel_conversation)],
        allow_reentry=True
    )
    application.add_handler(shadowsocks_conv_handler)

    # Add Balance Conversation Handler (Admin)
    add_balance_conv_handler = ConversationHandler(
        entry_points=[MessageHandler(filters.Regex(r'^➕ Tambah Saldo Pengguna$'), add_balance_conversation_start)],
        states={
            ADD_BALANCE_GET_USER_ID: [MessageHandler(filters.TEXT & ~filters.COMMAND, add_balance_get_user_id_step)],
            ADD_BALANCE_GET_AMOUNT: [MessageHandler(filters.TEXT & ~filters.COMMAND, add_balance_get_amount_step)],
        },
        fallbacks=[CommandHandler("cancel", cancel_conversation), MessageHandler(filters.COMMAND, cancel_conversation)],
        allow_reentry=True
    )
    application.add_handler(add_balance_conv_handler)

    # Check User Balance Conversation Handler (Admin)
    check_balance_user_conv_handler = ConversationHandler(
        entry_points=[MessageHandler(filters.Regex(r'^🔎 Cek Saldo Pengguna$'), check_user_balance_conversation_start)],
        states={
            CHECK_BALANCE_GET_USER_ID: [MessageHandler(filters.TEXT & ~filters.COMMAND, check_user_balance_get_user_id_step)],
        },
        fallbacks=[CommandHandler("cancel", cancel_conversation), MessageHandler(filters.COMMAND, cancel_conversation)],
        allow_reentry=True
    )
    application.add_handler(check_balance_user_conv_handler)

    # View User Transactions Conversation Handler (Admin)
    view_user_tx_conv_handler = ConversationHandler(
        entry_points=[MessageHandler(filters.Regex(r'^📜 Riwayat Transaksi Pengguna$'), view_user_tx_conversation_start)],
        states={
            VIEW_USER_TX_GET_USER_ID: [MessageHandler(filters.TEXT & ~filters.COMMAND, view_user_tx_get_user_id_step)],
        },
        fallbacks=[CommandHandler("cancel", cancel_conversation), MessageHandler(filters.COMMAND, cancel_conversation)],
        allow_reentry=True
    )
    application.add_handler(view_user_tx_conv_handler)


    # CommandHandler untuk Admin: Tambah Saldo (Opsional)
    application.add_handler(CommandHandler("add_balance", admin_add_balance_command))

    # Fallback Handler (paling akhir)
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, unknown))

    logger.info("Bot running in polling mode...")
    application.run_polling(allowed_updates=Update.ALL_TYPES)

if __name__ == "__main__":
    main()
