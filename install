#!/bin/bash

# =================================================================================
# Installer Otomatis Jualan Bot v4 (Paling Stabil)
# - Menginstal dependensi yang benar untuk Ubuntu 24.
# - Menampilkan output instalasi untuk debugging.
# - Mengunduh semua skrip dari GitHub.
# =================================================================================

# --- Warna untuk Output ---
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# --- Fungsi ---
info() { echo -e "\n${CYAN}[INFO]${NC} $1"; }
success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; exit 1; }

# --- Cek Root ---
if [ "$(id -u)" -ne 0 ]; then
   error "Skrip ini harus dijalankan sebagai root."
fi

# --- Meminta Input dari Pengguna ---
clear
echo -e "${GREEN}=====================================================${NC}"
echo -e "${GREEN} Selamat Datang di Installer Otomatis Jualan Bot ${NC}"
echo -e "${GREEN}             (Versi Final dan Stabil)              ${NC}"
echo -e "${GREEN}=====================================================${NC}"
echo "Pastikan Anda sudah mengubah jualan.py di GitHub"
echo "untuk menggunakan placeholder __BOT_TOKEN__ dan __ADMIN_IDS__."
echo ""

read -p "Masukkan BOT_TOKEN Anda: " BOT_TOKEN
read -p "Masukkan User ID Admin utama Anda: " ADMIN_ID
read -sp "Masukkan Password ROOT VPS Anda: " SSH_PASSWORD
echo ""; echo ""

if [ -z "$BOT_TOKEN" ] || [ -z "$ADMIN_ID" ] || [ -z "$SSH_PASSWORD" ]; then
    error "Semua input wajib diisi. Instalasi dibatalkan."
fi

# --- Variabel Global ---
BASE_URL="https://raw.githubusercontent.com/hokagelegend9999/bot_telegram/main"
VENV_PATH="/usr/bin/jualanbot_env"
BOT_DIR="/usr/bin"

# --- Proses Instalasi ---

info "1. Mengupdate sistem dan menginstal dependensi..."
apt-get update
apt-get upgrade -y
# Menginstal versi venv yang benar untuk Ubuntu 24 (python 3.12)
apt-get install -y python3 python3-pip python3.12-venv nginx at curl
if [ $? -ne 0 ]; then error "Gagal menginstal dependensi dasar."; fi
success "Dependensi sistem berhasil diinstal."

info "2. Membuat Lingkungan Virtual Python..."
mkdir -p ${VENV_PATH}
python3 -m venv ${VENV_PATH}
if [ $? -ne 0 ]; then error "Gagal membuat lingkungan virtual. Pastikan python3.12-venv terinstal."; fi
success "Lingkungan virtual berhasil dibuat di ${VENV_PATH}"

info "3. Menginstal pustaka Python ke dalam lingkungan virtual..."
# Perintah pip sekarang menampilkan outputnya untuk debugging
${VENV_PATH}/bin/pip install python-telegram-bot==21.0.1 paramiko
if [ $? -ne 0 ]; then error "Gagal menginstal pustaka Python. Periksa error di atas."; fi
success "Pustaka Python berhasil diinstal."

#info "4. Mengkonfigurasi SSH..."
#sed -i 's/^#*PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
#sed -i 's/^#*PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config
#systemctl restart ssh
#success "Konfigurasi SSH selesai."

info "5. Mengunduh semua skrip dari GitHub..."
SCRIPTS=(
    "jualan.py" "addss-bot" "addssh-bot" "addvless-bot" "addws-bot"
    "bot-backup" "bot-cek-login-ssh" "bot-trial" "bot-trialtrojan"
    "bot-trialvless" "bot-trialws" "bot-trialss" "bot-vps-info"
    "resservice" "bot-cek-vless" "bot-cek-vmess"
)
for script_name in "${SCRIPTS[@]}"; do
    echo -n "  -> Mengunduh ${script_name}..."
    curl -sL -o "${BOT_DIR}/${script_name}" "${BASE_URL}/${script_name}"
    if [ -s "${BOT_DIR}/${script_name}" ]; then
        chmod +x "${BOT_DIR}/${script_name}"
        echo -e " ${GREEN}OK${NC}"
    else
        echo -e " ${YELLOW}Gagal${NC}"
    fi
done
success "Proses pengunduhan skrip selesai."

info "6. Mengkonfigurasi jualan.py..."
if [ ! -f "${BOT_DIR}/jualan.py" ]; then
    error "File jualan.py tidak berhasil diunduh. Instalasi dihentikan."
fi
sed -i "s/__BOT_TOKEN__/${BOT_TOKEN}/g" "${BOT_DIR}/jualan.py"
sed -i "s/__ADMIN_IDS__/${ADMIN_ID}/g" "${BOT_DIR}/jualan.py"
success "jualan.py berhasil dikonfigurasi."

info "7. Membuat layanan systemd..."
cat > /etc/systemd/system/jualan_bot.service << EOF
[Unit]
Description=Jualan Telegram Bot
After=network.target

[Service]
WorkingDirectory=${BOT_DIR}/
ExecStart=${VENV_PATH}/bin/python3 ${BOT_DIR}/jualan.py
Restart=always
User=root
Group=root
Environment="SSH_USERNAME=root"
Environment="SSH_PASSWORD=${SSH_PASSWORD}"

[Install]
WantedBy=multi-user.target
EOF
chmod 600 /etc/systemd/system/jualan_bot.service
success "File layanan systemd berhasil dibuat."

info "8. Menyelesaikan instalasi dan menjalankan layanan..."
systemctl daemon-reload
systemctl enable jualan_bot.service > /dev/null 2>&1
systemctl restart jualan_bot.service
systemctl enable nginx > /dev/null 2>&1
systemctl restart nginx
systemctl enable atd > /dev/null 2>&1
systemctl start atd

echo ""
echo -e "${GREEN}=====================================================${NC}"
echo -e "${GREEN}       Instalasi Selesai & Bot Telah Aktif!       ${NC}"
echo -e "${GREEN}=====================================================${NC}"
echo ""
echo "Periksa status bot dengan: ${YELLOW}sudo systemctl status jualan_bot.service${NC}"
echo "Lihat log bot dengan: ${YELLOW}sudo journalctl -u jualan_bot.service -f${NC}"
echo ""
success "Silakan buka Telegram dan mulai gunakan bot Anda."
