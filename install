#!/bin/bash

# =================================================================================
# Installer Otomatis Jualan Bot v5 (Final & Multi-Distro)
# - Mendeteksi OS Ubuntu 24 / Debian 12
# - Mengunduh semua skrip dari GitHub
# - Konfigurasi otomatis & penanganan error
# =================================================================================

# --- Variabel dan Fungsi Bantuan ---
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
NC='\033[0m'

info() { echo -e "\n${CYAN}[INFO]${NC} $1"; }
success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; exit 1; }

# --- Cek Root ---
if [ "$(id -u)" -ne 0 ]; then
   error "Skrip ini harus dijalankan sebagai root. Coba 'sudo ./installer.sh'"
fi

# --- Meminta Input dari Pengguna ---
clear
echo -e "${GREEN}=====================================================${NC}"
echo -e "${GREEN} Selamat Datang di Installer Otomatis Jualan Bot ${NC}"
echo -e "${GREEN}             (Versi Final dan Stabil)              ${NC}"
echo -e "${GREEN}=====================================================${NC}"
echo "Pastikan Anda sudah menyiapkan informasi berikut dan"
echo "telah mengubah jualan.py di GitHub sesuai instruksi."
echo ""

read -p "Masukkan BOT_TOKEN Anda: " BOT_TOKEN
read -p "Masukkan User ID Admin utama Anda: " ADMIN_ID
read -sp "Masukkan Password ROOT VPS Anda: " SSH_PASSWORD
echo ""; echo ""

if [ -z "$BOT_TOKEN" ] || [ -z "$ADMIN_ID" ] || [ -z "$SSH_PASSWORD" ]; then
    error "Semua input wajib diisi. Instalasi dibatalkan."
fi

# --- Variabel Global ---
REPO_URL="https://raw.githubusercontent.com/hokagelegend9999/bot_telegram/main"
VENV_PATH="/usr/bin/jualanbot_env"
BOT_DIR="/usr/bin"

# --- Mulai Proses Instalasi ---

info "1. Mendeteksi OS dan Menginstal Dependensi..."
source /etc/os-release
if [[ "$ID" == "ubuntu" && "$VERSION_ID" == "24.04" ]]; then
    VENV_PKG="python3.12-venv"
elif [[ "$ID" == "debian" && "$VERSION_ID" == "12" ]]; then
    VENV_PKG="python3.11-venv"
else
    error "OS tidak didukung. Skrip ini hanya untuk Ubuntu 24 atau Debian 12."
fi

apt-get update
apt-get install -y python3 python3-pip "$VENV_PKG" nginx at curl jq
if [ $? -ne 0 ]; then error "Gagal menginstal dependensi dasar."; fi
success "Dependensi sistem berhasil diinstal."

info "2. Membuat Lingkungan Virtual Python..."
mkdir -p ${VENV_PATH}
python3 -m venv ${VENV_PATH}
if [ $? -ne 0 ]; then error "Gagal membuat lingkungan virtual."; fi

info "3. Menginstal pustaka Python ke dalam lingkungan virtual..."
${VENV_PATH}/bin/pip install python-telegram-bot==21.0.1 paramiko
if [ $? -ne 0 ]; then error "Gagal menginstal pustaka Python."; fi
success "Pustaka Python berhasil diinstal."

info "4. Mengkonfigurasi SSH..."
sed -i 's/^#*PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
sed -i 's/^#*PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config
systemctl restart ssh
success "Konfigurasi SSH selesai."

info "5. Mengunduh semua skrip dari GitHub..."
SCRIPTS=(
    "jualan.py" "addss-bot" "addssh-bot" "addvless-bot" "addws-bot" "bot-backup"
    "bot-cek-login-ssh" "bot-trial" "bot-trialtrojan" "bot-trialvless"
    "bot-trialws" "bot-trialss" "bot-vps-info" "resservice" "bot-cek-vless"
    "bot-cek-vmess" "bot-del-vless" "bot-del-vmess" "bot-del-trojan" "bot-del-ss"
    "bot-delssh" "bot-list-vless" "bot-list-vmess" "bot-list-trojan" "bot-list-shadowsocks"
    "bot-list-ssh" "bot-cek-tr" "bot-cek-ss" "bot-clearcache" "bot-restore"
)
for script_name in "${SCRIPTS[@]}"; do
    echo -n "  -> Mengunduh ${script_name}..."
    curl -sL -o "${BOT_DIR}/${script_name}" "${REPO_URL}/${script_name}"
    if [ -s "${BOT_DIR}/${script_name}" ]; then
        chmod +x "${BOT_DIR}/${script_name}"
        echo -e " ${GREEN}OK${NC}"
    else
        echo -e " ${YELLOW}Gagal${NC}"
        warning "Gagal mengunduh ${script_name}. Periksa nama file di GitHub."
    fi
done
success "Proses pengunduhan skrip selesai."

info "6. Mengkonfigurasi jualan.py..."
if [ ! -f "${BOT_DIR}/jualan.py" ]; then
    error "File jualan.py tidak berhasil diunduh. Instalasi dihentikan."
fi
sed -i "s/__BOT_TOKEN__/${BOT_TOKEN}/g" "${BOT_DIR}/jualan.py"
sed -i "s/__ADMIN_IDS__/${ADMIN_ID}/g" "${BOT_DIR}/jualan.py"
success "jualan.py berhasil dikonfigurasi."

info "7. Membuat layanan systemd..."
cat > /etc/systemd/system/jualan_bot.service << EOF
[Unit]
Description=Jualan Telegram Bot
After=network.target

[Service]
WorkingDirectory=${BOT_DIR}/
ExecStart=${VENV_PATH}/bin/python3 ${BOT_DIR}/jualan.py
Restart=always
User=root
Group=root
Environment="SSH_USERNAME=root"
Environment="SSH_PASSWORD=${SSH_PASSWORD}"

[Install]
WantedBy=multi-user.target
EOF
chmod 600 /etc/systemd/system/jualan_bot.service
success "File layanan systemd berhasil dibuat."

info "8. Menyelesaikan instalasi dan menjalankan layanan..."
systemctl daemon-reload
systemctl reset-failed jualan_bot.service
systemctl enable jualan_bot.service > /dev/null 2>&1
systemctl start jualan_bot.service

# Memastikan Nginx dan AT berjalan
systemctl enable nginx > /dev/null 2>&1
systemctl restart nginx
systemctl enable atd > /dev/null 2>&1
systemctl start atd

echo ""
echo -e "${GREEN}=====================================================${NC}"
echo -e "${GREEN}       INSTALASI SELESAI & BOT TELAH AKTIF!       ${NC}"
echo -e "${GREEN}=====================================================${NC}"
echo ""
echo "Bot Anda sekarang berjalan sebagai layanan di latar belakang."
echo "Periksa statusnya dengan perintah:"
echo -e "${YELLOW}sudo systemctl status jualan_bot.service${NC}"
echo ""
echo "Untuk melihat log bot secara real-time, gunakan:"
echo -e "${YELLOW}sudo journalctl -u jualan_bot.service -f${NC}"
echo ""
success "Silakan buka aplikasi Telegram dan mulai gunakan bot Anda."
